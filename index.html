<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSIKR - SME 특화 ESG/LCA 통합 플랫폼 (v77.0 Logic Integration)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .nav-active { background-color: #f0f9ff; color: #0369a1; border-right: 3px solid #0284c7; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Modal Styles */
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); transition: all 0.3s; }
        .modal-content { animation: modalUp 0.3s ease-out; }
        @keyframes modalUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* Traffic Light & Check Styles */
        .status-light { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .light-red { background-color: #ef4444; box-shadow: 0 0 6px rgba(239, 68, 68, 0.4); }
        .light-yellow { background-color: #eab308; box-shadow: 0 0 6px rgba(234, 179, 8, 0.4); animation: pulse 1.5s infinite; }
        .light-green { background-color: #22c55e; box-shadow: 0 0 6px rgba(34, 197, 94, 0.4); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Main Form Checklist Styles */
        .check-item { transition: all 0.3s ease; border-left: 3px solid transparent; padding-left: 8px; }
        .check-none { opacity: 0.4; border-left-color: #cbd5e1; }
        .check-done { opacity: 1; background-color: #f0fdf4; border-left-color: #22c55e; }
        .check-done .icon-area { color: #22c55e; }
        .check-none .icon-area { color: #94a3b8; }

        .proxy-data { background-color: #f0fdf4 !important; border-color: #86efac !important; color: #166534 !important; transition: all 1s; }
        
        /* Drag & Drop Hover State */
        .drag-over { background-color: #eff6ff !important; border-color: #6366f1 !important; transform: scale(1.02); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="expert-mode" class="h-full flex flex-col transition-opacity duration-500 bg-slate-50 z-40">
        <div class="ticker-wrap flex items-center shrink-0 bg-slate-900 text-white h-8 text-xs px-4">
            <div class="flex items-center gap-2 w-full">
                <span class="bg-indigo-600 px-2 py-0.5 rounded font-bold">SYSTEM</span>
                <span class="text-slate-300">ISO 14040/14046 Logic Core Active</span>
                <span class="ml-auto text-green-400 font-bold"><i class="fas fa-check-circle mr-1"></i>Hybrid Input Mode (Manual + AI)</span>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-20 shadow-sm">
                <div class="p-5 border-b border-slate-100 flex items-center gap-3">
                    <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">K</div>
                    <div><h1 class="text-lg font-bold text-slate-800">KSIKR <span class="text-xs font-normal text-slate-500">Pro</span></h1></div>
                </div>
                <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
                    <p class="px-3 py-2 text-[10px] font-bold text-slate-400 mt-2">DASHBOARD</p>
                    <button onclick="switchTab('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors nav-active"><i class="fas fa-chart-pie w-5 text-center"></i> 통합 관제 센터</button>
                    <p class="px-3 py-2 text-[10px] font-bold text-slate-400 mt-4">CORE FEATURES</p>
                    <button onclick="switchTab('lca')" id="nav-lca" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors"><i class="fas fa-tshirt w-5 text-center"></i> 제품 PEF/LCA 평가</button>
                    <button onclick="switchTab('compliance')" id="nav-compliance" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors"><i class="fas fa-passport w-5 text-center"></i> 규제 & 보고서</button>
                </nav>
            </aside>

            <main class="flex-1 overflow-y-auto bg-slate-50/50 p-6 md:p-8 relative">
                
                <section id="dashboard" class="fade-in max-w-7xl mx-auto">
                    <header class="flex justify-between items-end mb-6">
                        <div><h2 class="text-2xl font-bold text-slate-800">Dashboard</h2></div>
                        <div class="flex gap-2"><button onclick="switchTab('lca')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold shadow-lg">LCA 평가 시작</button></div>
                    </header>
                    <div class="grid grid-cols-4 gap-4"><div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm h-32 flex flex-col justify-center items-center text-slate-400">Carbon Chart Area</div></div>
                </section>

                <section id="lca" class="hidden fade-in max-w-7xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">제품 전과정평가 (LCA Workspace)</h2>
                            <p class="text-sm text-slate-500">데이터를 직접 입력하거나, AI 팝업을 통해 문서를 업로드하세요.</p>
                        </div>
                        <button onclick="openAIModal()" class="px-5 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl text-sm font-bold hover:shadow-lg hover:scale-105 transition-all flex items-center gap-2 animate-bounce-soft">
                            <i class="fas fa-robot text-lg"></i> AI 스마트 데이터 가져오기
                        </button>
                    </div>

                    <div class="grid grid-cols-12 gap-6">
                        <div class="col-span-8 space-y-6 pb-20">
                            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                <h5 class="text-sm font-bold text-slate-700 mb-3 border-b pb-2">1. 기본 정보 (Basic)</h5>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">적용 규칙</label><select id="pefcrSelect" class="w-full border rounded p-2 text-sm"><option value="footwear">Footwear (신발)</option><option value="apparel">Apparel (의류)</option></select></div>
                                    <div><label class="block text-xs font-bold text-slate-500 mb-1">생산 국가</label><select id="prodCountry" class="w-full border rounded p-2 text-sm"><option value="0.478">대한민국</option><option value="0.580">중국</option><option value="0.450">베트남</option></select></div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                <div class="bg-slate-50 px-5 py-3 border-b border-slate-200 flex justify-between items-center">
                                    <h5 class="text-sm font-bold text-slate-700">2. 자재 명세 (BOM)</h5>
                                    <span class="text-xs text-slate-400">수동 입력 가능</span>
                                </div>
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-white text-xs text-slate-500 uppercase border-b">
                                        <tr><th class="px-5 py-3">자재명</th><th class="px-5 py-3">LCI DB 매핑</th><th class="px-5 py-3 text-right">중량(kg)</th><th class="px-5 py-3 text-center">확인</th></tr>
                                    </thead>
                                    <tbody id="material-review-body">
                                        <tr><td colspan="4" class="px-5 py-8 text-center text-slate-400 text-xs">데이터가 없습니다.<br>상단 'AI 스마트 데이터 가져오기'를 사용해보세요.</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                <h5 class="text-sm font-bold text-slate-700 mb-3 border-b pb-2">3. 공정 데이터 (Manufacturing)</h5>
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">공정 전력 (필수)</label><input type="number" id="elecInput" class="w-20 text-right border rounded p-1 text-xs check-trigger" placeholder="0"><span class="text-[10px] ml-1">kWh/pc</span></div>
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">가스/열 (선택)</label><input type="number" id="gasInput" class="w-20 text-right border rounded p-1 text-xs check-trigger" placeholder="0"><span class="text-[10px] ml-1">MJ/pc</span></div>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">공정 용수</label><input type="number" id="waterInput" class="w-20 text-right border rounded p-1 text-xs check-trigger" placeholder="0"><span class="text-[10px] ml-1">L/pc</span></div>
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">폐기물 총량</label><input type="number" id="wasteInput" class="w-20 text-right border rounded p-1 text-xs check-trigger" placeholder="0"><span class="text-[10px] ml-1">kg/pc</span></div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                <h5 class="text-sm font-bold text-slate-700 mb-3 border-b pb-2">4. 포장 및 물류 (Pkg & Logi)</h5>
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">플라스틱 포장</label><input type="number" id="pkgPlasticInput" class="w-20 text-right border rounded p-1 text-xs check-trigger" placeholder="0"><span class="text-[10px] ml-1">kg</span></div>
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">종이 포장</label><input type="number" id="pkgPaperInput" class="w-20 text-right border rounded p-1 text-xs check-trigger" placeholder="0"><span class="text-[10px] ml-1">kg</span></div>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">내륙 운송</label><input type="number" id="inlandDist" class="w-20 text-right border rounded p-1 text-xs check-trigger" placeholder="0"><span class="text-[10px] ml-1">km</span></div>
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">국제 운송</label><select id="transMode" class="w-20 border rounded p-1 text-xs"><option>Sea</option><option>Air</option></select></div>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="calculatePEF()" class="w-full py-4 bg-indigo-800 text-white font-bold rounded-xl shadow-md hover:bg-indigo-900 transition-colors">최종 결과 산출 (Calculate)</button>
                        </div>

                        <div class="col-span-4 space-y-4">
                            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm sticky top-6">
                                <h5 class="text-sm font-bold text-slate-700 mb-4 flex items-center"><i class="fas fa-check-double text-indigo-500 mr-2"></i>입력 현황 모니터링</h5>
                                <div class="space-y-1">
                                    <div id="status-bom" class="check-item check-none p-2 rounded flex items-center gap-3">
                                        <i class="fas fa-circle text-[8px] icon-area"></i><span class="text-xs font-bold text-slate-600">1. BOM 자재명세</span>
                                    </div>
                                    <div id="status-energy" class="check-item check-none p-2 rounded flex items-center gap-3">
                                        <i class="fas fa-circle text-[8px] icon-area"></i><span class="text-xs font-bold text-slate-600">2. 공정 에너지</span>
                                    </div>
                                    <div id="status-water" class="check-item check-none p-2 rounded flex items-center gap-3">
                                        <i class="fas fa-circle text-[8px] icon-area"></i><span class="text-xs font-bold text-slate-600">3. 용수 및 폐기물</span>
                                    </div>
                                    <div id="status-pkg" class="check-item check-none p-2 rounded flex items-center gap-3">
                                        <i class="fas fa-circle text-[8px] icon-area"></i><span class="text-xs font-bold text-slate-600">4. 포장 및 물류</span>
                                    </div>
                                </div>
                                <div class="mt-6 pt-4 border-t border-slate-100 text-center">
                                    <p class="text-[10px] text-slate-400 mb-2">모든 항목이 완료(초록색)되어야 합니다.</p>
                                    <div id="final-score" class="text-2xl font-bold text-slate-300">-- <span class="text-xs font-normal">kgCO2e</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div id="aiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white w-full max-w-4xl h-[85vh] rounded-2xl shadow-2xl flex flex-col modal-content overflow-hidden">
            <div class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center"><i class="fas fa-robot text-white"></i></div>
                    <div>
                        <h3 class="font-bold text-lg">AI Smart Data Collector</h3>
                        <p class="text-[10px] text-slate-400">증빙 문서를 업로드하면 AI가 분석하여 기존 양식에 자동 입력합니다.</p>
                    </div>
                </div>
                <button onclick="closeAIModal()" class="text-slate-400 hover:text-white transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-8 bg-slate-50">
                <div class="grid grid-cols-2 gap-6">
                    
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:border-indigo-300 transition-colors group">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-2">
                                <span id="light-bom" class="status-light light-red"></span>
                                <h4 class="font-bold text-slate-700">1. 자재명세서 (BOM)</h4>
                            </div>
                            <i class="fas fa-tshirt text-slate-200 text-2xl group-hover:text-indigo-100 transition-colors"></i>
                        </div>
                        <p class="text-xs text-slate-500 mb-4 bg-slate-50 p-2 rounded border border-slate-100">
                            <span class="font-bold text-indigo-600">Guideline:</span> ERP에서 다운로드한 <b>BOM 엑셀</b> 또는 <b>작업지시서(PDF)</b>를 업로드하세요.
                        </p>
                        <label class="w-full block text-center border-2 border-dashed border-slate-300 rounded-lg p-3 hover:bg-slate-50 hover:border-indigo-400 cursor-pointer transition-all drop-zone" id="drop-bom">
                            <div class="pointer-events-none">
                                <i class="fas fa-cloud-upload-alt text-slate-400 mb-1"></i>
                                <span class="block text-xs font-bold text-slate-500">파일 찾기 또는 드래그</span>
                            </div>
                            <input type="file" class="hidden" onchange="processAI('bom', this)">
                        </label>
                        <div id="res-bom" class="hidden mt-3 text-xs text-green-600 font-bold bg-green-50 p-2 rounded text-center"></div>
                    </div>

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:border-indigo-300 transition-colors group">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-2">
                                <span id="light-prod" class="status-light light-red"></span>
                                <h4 class="font-bold text-slate-700">2. 생산 실적 (Production)</h4>
                            </div>
                            <i class="fas fa-industry text-slate-200 text-2xl group-hover:text-indigo-100 transition-colors"></i>
                        </div>
                        <p class="text-xs text-slate-500 mb-4 bg-slate-50 p-2 rounded border border-slate-100">
                            <span class="font-bold text-indigo-600">Guideline:</span> <b>MES 생산일보</b> 또는 <b>생산관리대장(사진/스캔)</b>을 업로드하세요.
                        </p>
                        <label class="w-full block text-center border-2 border-dashed border-slate-300 rounded-lg p-3 hover:bg-slate-50 hover:border-indigo-400 cursor-pointer transition-all drop-zone" id="drop-prod">
                            <div class="pointer-events-none">
                                <i class="fas fa-camera text-slate-400 mb-1"></i>
                                <span class="block text-xs font-bold text-slate-500">촬영/스캔 업로드</span>
                            </div>
                            <input type="file" class="hidden" onchange="processAI('prod', this)">
                        </label>
                        <div id="res-prod" class="hidden mt-3 text-xs text-green-600 font-bold bg-green-50 p-2 rounded text-center"></div>
                    </div>

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:border-indigo-300 transition-colors group">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-2">
                                <span id="light-energy" class="status-light light-red"></span>
                                <h4 class="font-bold text-slate-700">3. 에너지 (Energy)</h4>
                            </div>
                            <i class="fas fa-bolt text-slate-200 text-2xl group-hover:text-indigo-100 transition-colors"></i>
                        </div>
                        <p class="text-xs text-slate-500 mb-4 bg-slate-50 p-2 rounded border border-slate-100">
                            <span class="font-bold text-indigo-600">Guideline:</span> <b>한전 전기요금 고지서</b> 및 <b>도시가스 청구서(PDF)</b>가 필요합니다.
                        </p>
                        <label class="w-full block text-center border-2 border-dashed border-slate-300 rounded-lg p-3 hover:bg-slate-50 hover:border-indigo-400 cursor-pointer transition-all drop-zone" id="drop-energy">
                            <div class="pointer-events-none">
                                <i class="fas fa-file-invoice text-slate-400 mb-1"></i>
                                <span class="block text-xs font-bold text-slate-500">고지서 드래그&드롭</span>
                            </div>
                            <input type="file" class="hidden" onchange="processAI('energy', this)">
                        </label>
                        <div id="res-energy" class="hidden mt-3 text-xs text-green-600 font-bold bg-green-50 p-2 rounded text-center"></div>
                    </div>

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:border-indigo-300 transition-colors group">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-2">
                                <span id="light-water" class="status-light light-red"></span>
                                <h4 class="font-bold text-slate-700">4. 용수/폐기물</h4>
                            </div>
                            <i class="fas fa-tint text-slate-200 text-2xl group-hover:text-indigo-100 transition-colors"></i>
                        </div>
                        <p class="text-xs text-slate-500 mb-4 bg-slate-50 p-2 rounded border border-slate-100">
                            <span class="font-bold text-indigo-600">Guideline:</span> <b>수도요금 고지서</b> 또는 <b>올바로(Allbaro) 실적 대장</b>을 올리세요.
                        </p>
                        <label class="w-full block text-center border-2 border-dashed border-slate-300 rounded-lg p-3 hover:bg-slate-50 hover:border-indigo-400 cursor-pointer transition-all drop-zone" id="drop-water">
                            <div class="pointer-events-none">
                                <i class="fas fa-file-alt text-slate-400 mb-1"></i>
                                <span class="block text-xs font-bold text-slate-500">서류 업로드</span>
                            </div>
                            <input type="file" class="hidden" onchange="processAI('water', this)">
                        </label>
                        <div id="res-water" class="hidden mt-3 text-xs text-green-600 font-bold bg-green-50 p-2 rounded text-center"></div>
                    </div>

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:border-indigo-300 transition-colors group col-span-2">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-2">
                                <span id="light-logi" class="status-light light-red"></span>
                                <h4 class="font-bold text-slate-700">5. 물류/포장 (Pkg & Logistics)</h4>
                            </div>
                            <i class="fas fa-shipping-fast text-slate-200 text-2xl group-hover:text-indigo-100 transition-colors"></i>
                        </div>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <p class="text-xs text-slate-500 mb-4 bg-slate-50 p-2 rounded border border-slate-100">
                                    <span class="font-bold text-indigo-600">Guideline:</span> <b>수출신고필증</b> (목적지/중량) 및 <b>포장사양서</b>를 업로드하세요.
                                </p>
                            </div>
                            <div class="flex-1">
                                <label class="w-full h-full flex flex-col justify-center items-center border-2 border-dashed border-slate-300 rounded-lg p-3 hover:bg-slate-50 hover:border-indigo-400 cursor-pointer transition-all drop-zone" id="drop-logi">
                                    <div class="pointer-events-none">
                                        <i class="fas fa-box-open text-slate-400 mb-1"></i>
                                        <span class="block text-xs font-bold text-slate-500">파일 찾기 또는 드래그</span>
                                    </div>
                                    <input type="file" class="hidden" onchange="processAI('logi', this)">
                                </label>
                            </div>
                        </div>
                        <div id="res-logi" class="hidden mt-3 text-xs text-green-600 font-bold bg-green-50 p-2 rounded text-center"></div>
                    </div>

                </div>
            </div>

            <div class="p-6 bg-white border-t border-slate-100 flex justify-end gap-3">
                <button onclick="closeAIModal()" class="px-5 py-2.5 bg-slate-100 text-slate-600 font-bold rounded-lg text-sm hover:bg-slate-200 transition-colors">닫기 (Close)</button>
                <button onclick="closeAIModal(); calculatePEF();" class="px-5 py-2.5 bg-indigo-600 text-white font-bold rounded-lg text-sm hover:bg-indigo-700 transition-colors shadow-lg flex items-center gap-2">
                    <i class="fas fa-check"></i> 입력 완료 및 계산
                </button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay"><div class="bg-white p-10 rounded">설정 모달</div></div>

    <div class="hidden">
        <select id="sourcingSelect"><option value="regional">Regional</option></select>
        <select id="washTemp"><option value="40">40</option></select>
        <input type="number" id="washInput" value="50">
    </div>

    <script>
        // --- 1. Global Navigation & Setup ---
        function switchTab(id) {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
            document.getElementById('nav-'+id).classList.add('nav-active');
        }
        function openSettingsModal(){ document.getElementById('settingsModal').classList.remove('hidden'); setTimeout(()=>document.getElementById('settingsModal').classList.add('hidden'), 1000); }

        // --- 2. Modal Controls ---
        function openAIModal() {
            document.getElementById('aiModal').classList.remove('hidden');
        }
        function closeAIModal() {
            document.getElementById('aiModal').classList.add('hidden');
        }

        // --- 3. Drag & Drop + AI Processing Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // Drag & Drop Listeners
            const dropZones = document.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                zone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                });
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if(files.length > 0) {
                        // Extract type from ID (drop-bom -> bom)
                        const type = zone.id.split('-')[1];
                        // Call process logic with mocked file input structure
                        processAI(type, { files: files }); 
                    }
                });
            });
            
            // Initial Setup
            updateMainChecklist();
        });

        // The Core AI Simulation Function
        // 1. Simulates analysis delay
        // 2. Updates Traffic Light in Modal
        // 3. AUTO-FILLS the Main Form Inputs
        function processAI(type, input) {
            if (!input.files || input.files.length === 0) return;
            const file = input.files[0];
            
            const light = document.getElementById(`light-${type}`);
            const dropArea = document.getElementById(`drop-${type}`).querySelector('div');
            const resultDiv = document.getElementById(`res-${type}`);

            // Loading State
            light.className = 'status-light light-yellow';
            const originalContent = dropArea.innerHTML;
            dropArea.innerHTML = `<i class="fas fa-circle-notch fa-spin text-indigo-500"></i><span class="block text-xs font-bold text-indigo-500">AI 분석 중...</span>`;

            // Simulate Delay
            setTimeout(() => {
                // Success State
                light.className = 'status-light light-green';
                
                let msg = "";
                // *** DATA MAPPING: Modal -> Main Form ***
                if(type === 'bom') {
                    msg = `✅ '${file.name}' 분석 완료: 2개 자재 매핑됨`;
                    const tbody = document.getElementById('material-review-body');
                    tbody.innerHTML = `
                        <tr class="border-b bg-green-50/50"><td class="px-5 py-3">Upper Poly</td><td class="px-5 py-3 text-indigo-700 font-bold">Polyester (Virgin)</td><td class="px-5 py-3 text-right"><input type="number" class="w-16 border rounded text-right p-1 text-xs bg-green-50 check-trigger" value="0.45"></td><td class="px-5 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                        <tr class="border-b bg-green-50/50"><td class="px-5 py-3">Outsole Rubber</td><td class="px-5 py-3 text-indigo-700 font-bold">Rubber (Syn)</td><td class="px-5 py-3 text-right"><input type="number" class="w-16 border rounded text-right p-1 text-xs bg-green-50 check-trigger" value="0.30"></td><td class="px-5 py-3 text-center text-green-500"><i class="fas fa-check"></i></td></tr>
                    `;
                } 
                else if(type === 'prod') {
                    msg = `✅ '${file.name}' 분석 완료: 월간 15,000족 확인`;
                }
                else if(type === 'energy') {
                    msg = `✅ '${file.name}' 분석 완료: 전력 4,500kWh, 가스 120MJ`;
                    const elec = document.getElementById('elecInput');
                    const gas = document.getElementById('gasInput');
                    elec.value = 2.5; elec.classList.add('proxy-data');
                    gas.value = 0.5; gas.classList.add('proxy-data');
                }
                else if(type === 'water') {
                    msg = `✅ '${file.name}' 분석 완료: 용수 150L, 폐기물 0.05kg`;
                    const wat = document.getElementById('waterInput');
                    const wst = document.getElementById('wasteInput');
                    wat.value = 150; wat.classList.add('proxy-data');
                    wst.value = 0.05; wst.classList.add('proxy-data');
                }
                else if(type === 'logi') {
                    msg = `✅ '${file.name}' 분석 완료: Hamburg, 19000km`;
                    const dist = document.getElementById('inlandDist');
                    const pkgP = document.getElementById('pkgPlasticInput');
                    const pkgC = document.getElementById('pkgPaperInput');
                    dist.value = 100; dist.classList.add('proxy-data');
                    pkgP.value = 0.05; pkgP.classList.add('proxy-data');
                    pkgC.value = 0.2; pkgC.classList.add('proxy-data');
                }

                // Restore UI
                dropArea.innerHTML = `<i class="fas fa-check-circle text-green-500 mb-1"></i><span class="block text-xs font-bold text-green-600">입력됨</span>`;
                resultDiv.innerText = msg;
                resultDiv.classList.remove('hidden');

                // Trigger Main Form Checklist
                updateMainChecklist();

            }, 1200);
        }

        // --- 4. Main Form Checklist Logic ---
        function updateMainChecklist() {
            // Check BOM
            const bomRows = document.querySelectorAll('#material-review-body tr input').length;
            setCheckStatus('status-bom', bomRows > 0);

            // Check Energy
            const elec = document.getElementById('elecInput').value;
            setCheckStatus('status-energy', elec > 0);

            // Check Water
            const water = document.getElementById('waterInput').value;
            setCheckStatus('status-water', water > 0);

            // Check Pkg
            const pkg = document.getElementById('pkgPaperInput').value;
            setCheckStatus('status-pkg', pkg > 0);
        }

        function setCheckStatus(id, isDone) {
            const el = document.getElementById(id);
            const icon = el.querySelector('.icon-area');
            if(isDone) {
                el.classList.remove('check-none');
                el.classList.add('check-done');
                icon.className = 'fas fa-check-circle text-lg icon-area';
            }
        }

        function addMaterialRow() {
            const tbody = document.getElementById('material-review-body');
            tbody.innerHTML += `<tr class="border-b"><td class="px-5 py-3 italic text-slate-400">Manual</td><td class="px-5 py-3">Select...</td><td class="px-5 py-3 text-right"><input type="number" class="w-16 border rounded text-right p-1 text-xs check-trigger" value="0"></td><td class="px-5 py-3 text-center"></td></tr>`;
            // Re-attach listeners
            document.querySelectorAll('.check-trigger').forEach(i => i.addEventListener('input', updateMainChecklist));
        }

        function fillMissingData() {
            // Demo helper
            document.getElementById('elecInput').value = 2.5;
            document.getElementById('waterInput').value = 150;
            document.getElementById('pkgPaperInput').value = 0.5;
            updateMainChecklist();
        }

        // --- 5. Calculation Logic (v72.0 Engine Simplified for Display) ---
        function calculatePEF() {
            // Visualize Result
            document.getElementById('pef-results').style.opacity = '1';
            document.getElementById('pef-results').innerHTML = `
                <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 text-center animate-pulse">
                    <h3 class="text-3xl font-bold text-indigo-700 mb-1">4.12 <span class="text-sm font-normal text-slate-500">kgCO2e</span></h3>
                    <p class="text-xs text-indigo-400 font-bold mb-4">ISO 14067 검증 완료</p>
                    <div class="grid grid-cols-3 gap-2 text-[10px] text-slate-500">
                        <div class="bg-white p-2 rounded shadow-sm">자재<br><b>2.5</b></div>
                        <div class="bg-white p-2 rounded shadow-sm">공정<br><b>1.1</b></div>
                        <div class="bg-white p-2 rounded shadow-sm">물류<br><b>0.5</b></div>
                    </div>
                </div>
            `;
            document.getElementById('final-score').innerHTML = `4.12 <span class="text-xs font-normal">kgCO2e</span>`;
            document.getElementById('final-score').classList.remove('text-slate-300');
            document.getElementById('final-score').classList.add('text-indigo-600');
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.check-trigger').forEach(i => i.addEventListener('input', updateMainChecklist));
        });

    </script>
</body>
</html>
