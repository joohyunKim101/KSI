<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSIKR - Official ESG/LCA Platform (v104.0 Standard)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .nav-item { transition: all 0.2s; border-radius: 12px; font-weight: 600; color: #64748b; font-size: 14px; }
        .nav-item:hover { background-color: #f1f5f9; color: #334155; }
        .nav-active { background-color: #e0e7ff; color: #4338ca; box-shadow: 0 4px 6px -1px rgba(67, 56, 202, 0.1); }
        .kpi-card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .input-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 8px 12px; font-size: 13px; text-align: right; transition: all 0.2s; }
        .input-field:focus { border-color: #6366f1; outline: none; ring: 2px solid #e0e7ff; }
        .input-readonly { background-color: #f1f5f9; color: #64748b; cursor: not-allowed; }
        .report-paper { width: 210mm; min-height: 297mm; padding: 20mm; margin: 0 auto; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; font-family: 'Times New Roman', serif; }
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
        .report-table th, .report-table td { border: 1px solid #000; padding: 6px; text-align: left; }
        .report-table th { background-color: #f3f4f6; font-weight: bold; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* AI Modal Styles */
        .modal-overlay { background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); transition: all 0.3s; }
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.2s; background-color: white; cursor: pointer; }
        .drop-zone.drag-over { border-color: #6366f1; background-color: #e0e7ff; transform: scale(1.02); }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <script>
        window.appState = {
            totalGWP: 0.00,
            breakdown: [0, 0, 0, 0, 0], // Mat, Mfg, Dist, Use, EOL
            history: [
                { date: '2025-10-15', product: 'Basic Tee v1', gwp: 12.5 },
                { date: '2025-11-02', product: 'Summer Line', gwp: 15.2 },
                { date: '2025-11-20', product: 'Basic T-Shirt', gwp: 3.85 },
                { date: '2025-12-05', product: 'Denim Pants', gwp: 12.4 }
            ]
        };

        // Official PEFCR Defaults
        const PEF_CATS = { 
            'tshirt': { name: 'T-Shirts (Knitted)', life: 52, wash_temp: 40, iron: 0.2, dry: 'line' }, 
            'pants': { name: 'Pants (Woven)', life: 100, wash_temp: 30, iron: 0.5, dry: 'tumble' },
            'jacket': { name: 'Jacket', life: 150, wash_temp: 30, iron: 0, dry: 'line' }
        };
        const GRID_DB = { 'KR': { name: 'South Korea', factor: 0.478 }, 'CN': { name: 'China', factor: 0.584 }, 'VN': { name: 'Vietnam', factor: 0.450 } };
        const MATERIAL_DB = { 'cotton': { name: 'Cotton', ef: 1.8 }, 'poly': { name: 'Polyester', ef: 4.6 } };
        const PROCESS_DB = { 'spinning': { name: 'Spinning', energy: 3.5 }, 'sewing': { name: 'Sewing', energy: 1.2 } };
    </script>

    <div class="h-10 bg-slate-900 text-white flex items-center px-6 text-xs font-medium justify-between z-50 shadow-md shrink-0">
        <div class="flex items-center gap-4">
            <span class="bg-indigo-600 px-2 py-0.5 rounded text-[10px] font-bold tracking-wider">KSIKR OFFICIAL</span>
            <span class="text-slate-400">ISO 14067 / PEFCR Standard</span>
        </div>
        <div class="flex items-center gap-4">
            <span class="bg-yellow-600 px-2 py-0.5 rounded text-[10px] font-bold text-white">Enterprise Plan</span>
            <span class="flex items-center gap-2"><i class="fas fa-user-circle text-slate-500"></i> Admin</span>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden h-full">
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-40">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-700 rounded-xl flex items-center justify-center text-white font-black text-xl shadow-lg">K</div>
                <div><h1 class="text-lg font-extrabold text-slate-900">KSIKR <span class="text-indigo-600">LCA</span></h1></div>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 nav-active"><i class="fas fa-chart-line w-5 text-center"></i> 대시보드</button>
                <button onclick="switchTab('lca')" id="btn-lca" class="nav-item w-full flex items-center gap-3 px-4 py-3"><i class="fas fa-calculator w-5 text-center"></i> 정밀 LCA 산정</button>
                <button onclick="switchTab('report')" id="btn-report" class="nav-item w-full flex items-center gap-3 px-4 py-3"><i class="fas fa-file-contract w-5 text-center"></i> 인증 리포트</button>
                <button onclick="switchTab('corporate')" id="btn-corporate" class="nav-item w-full flex items-center gap-3 px-4 py-3"><i class="fas fa-building w-5 text-center"></i> 기업 정보</button>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto relative scroll-smooth bg-slate-50 p-8">
            <section id="tab-dashboard" class="fade-in max-w-7xl mx-auto">
                <header class="flex justify-between items-end mb-8">
                    <div><h2 class="text-3xl font-bold text-slate-800">통합 관제 대시보드</h2></div>
                    <button onclick="switchTab('lca')" class="px-5 py-2.5 bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-indigo-700">신규 평가 시작</button>
                </header>
                <div class="grid grid-cols-4 gap-5 mb-8">
                    <div class="kpi-card"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500">AVG GWP</span></div><h3 class="text-2xl font-bold text-slate-800"><span id="dash-avg-gwp">--</span> kg</h3></div>
                    <div class="kpi-card"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500">GRADE</span></div><h3 class="text-xl font-bold text-green-700">A+ (Low Carbon)</h3></div>
                    <div class="kpi-card"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500">RISK</span></div><h3 class="text-2xl font-bold text-slate-800">Low</h3></div>
                    <div class="kpi-card"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500">COST</span></div><h3 class="text-2xl font-bold text-slate-800">Save 12%</h3></div>
                </div>
                <div class="grid grid-cols-3 gap-6">
                    <div class="col-span-2 bg-white p-6 rounded-2xl border shadow-sm"><h4 class="font-bold text-slate-800 mb-4">배출량 추이 (History Trend)</h4><div class="h-64"><canvas id="lineChart"></canvas></div></div>
                    <div class="col-span-1 bg-white p-6 rounded-2xl border shadow-sm"><h4 class="font-bold text-slate-800 mb-4">공정별 핫스팟 (5 Stages)</h4><div class="h-64"><canvas id="donutChart"></canvas></div></div>
                </div>
            </section>

            <section id="tab-lca" class="hidden fade-in max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">정밀 전과정평가 (ISO 14067)</h2>
                    <button onclick="openAI()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-lg text-sm font-bold shadow hover:shadow-lg flex items-center gap-2">
                        <i class="fas fa-robot"></i> AI 데이터 분류 업로드
                    </button>
                </div>

                <div class="grid grid-cols-12 gap-8">
                    <div class="col-span-8 space-y-6 pb-20">
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <h5 class="font-bold text-slate-800 mb-4 border-l-4 border-indigo-600 pl-3">1. 목표 및 범위 (Goal & Scope)</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500">제품군 (PEFCR)</label><select id="lca-cat" class="input-field" onchange="setDefaults()"></select></div>
                                <div><label class="text-xs font-bold text-slate-500">생산 국가 (Grid)</label><select id="lca-grid" class="input-field" onchange="calc()"></select></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl border shadow-sm p-6">
                            <h5 class="font-bold text-slate-800 mb-4 border-l-4 border-indigo-600 pl-3">2. 자재명세 (Materials - Upstream)</h5>
                            <table class="w-full text-sm text-left mb-2"><tbody id="bom-body"></tbody></table>
                            <button onclick="addBomRow()" class="text-xs bg-indigo-50 text-indigo-700 px-3 py-1 rounded font-bold">+ 자재 추가</button>
                        </div>
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <h5 class="font-bold text-slate-800 mb-4 border-l-4 border-indigo-600 pl-3">3. 제조 공정 (Production - Core)</h5>
                            <div class="grid grid-cols-3 gap-4">
                                <div><label class="text-xs font-bold text-slate-500">공정 전력 (kWh)</label><input type="number" id="inp-elec" class="input-field" oninput="calc()"></div>
                                <div><label class="text-xs font-bold text-slate-500">공정 가스 (MJ)</label><input type="number" id="inp-gas" class="input-field" oninput="calc()"></div>
                                <div><label class="text-xs font-bold text-slate-500">공업 용수 (ton)</label><input type="number" id="inp-water" class="input-field" oninput="calc()"></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <h5 class="font-bold text-slate-800 mb-4 border-l-4 border-indigo-600 pl-3">4. 유통 및 물류 (Distribution - Downstream)</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500">포장재/중량(kg)</label><div class="flex gap-2"><select id="lca-pack" class="input-field"></select><input id="lca-pw" type="number" class="input-field w-20" value="0.05" oninput="calc()"></div></div>
                                <div><label class="text-xs font-bold text-slate-500">운송수단/거리(km)</label><div class="flex gap-2"><select id="lca-ship" class="input-field"><option value="ship">선박</option><option value="air">항공</option></select><input id="lca-dist" type="number" class="input-field w-20" value="10000" oninput="calc()"></div></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <h5 class="font-bold text-slate-800 mb-4 border-l-4 border-indigo-600 pl-3">5. 사용 및 폐기 (Use & EOL)</h5>
                            <div class="grid grid-cols-4 gap-4">
                                <div><label class="text-xs font-bold text-indigo-600">총 세탁횟수(회)</label><input type="number" id="lca-wash" class="input-field bg-indigo-50 font-bold" oninput="calc()"></div>
                                <div><label class="text-xs font-bold text-indigo-600">세탁 온도(℃)</label><input type="number" id="lca-temp" class="input-field bg-indigo-50 font-bold" oninput="calc()"></div>
                                <div><label class="text-xs font-bold text-indigo-600">다림질 시간(hr)</label><input type="number" id="lca-iron" class="input-field bg-indigo-50 font-bold" oninput="calc()"></div>
                                <div><label class="text-xs font-bold text-slate-500">폐기 시나리오</label><select id="lca-eol" class="input-field" onchange="calc()"><option value="landfill">매립 (Landfill)</option><option value="incineration">소각 (Incineration)</option><option value="recycle">재활용 (Recycle)</option></select></div>
                            </div>
                            <p class="text-[10px] text-indigo-500 mt-2">* PEFCR 규정에 의거하여 제품 카테고리별 기본값(Default)이 자동 적용됩니다.</p>
                        </div>
                    </div>

                    <div class="col-span-4">
                        <div class="bg-slate-900 text-white rounded-xl p-6 shadow-xl sticky top-6">
                            <h5 class="text-xs font-bold text-slate-400 mb-4">TOTAL IMPACT (ISO 14067)</h5>
                            <div class="text-4xl font-black mb-6"><span id="live-total">0.00</span> <span class="text-base font-normal text-slate-400">kgCO2e</span></div>
                            <div class="space-y-3 text-sm border-t border-slate-700 pt-4">
                                <div class="flex justify-between"><span>1. 자재 (Mat)</span><span id="res-mat">0.00</span></div>
                                <div class="flex justify-between"><span>2. 제조 (Mfg)</span><span id="res-eng">0.00</span></div>
                                <div class="flex justify-between"><span>3. 유통 (Dist)</span><span id="res-dist">0.00</span></div>
                                <div class="flex justify-between"><span>4. 사용 (Use)</span><span id="res-use">0.00</span></div>
                                <div class="flex justify-between"><span>5. 폐기 (EOL)</span><span id="res-eol">0.00</span></div>
                            </div>
                            <button onclick="saveCalc()" class="w-full bg-indigo-600 hover:bg-indigo-500 mt-8 py-3 rounded-lg font-bold shadow-lg transition">결과 확정 및 저장</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tab-report" class="hidden fade-in max-w-5xl mx-auto">
                <header class="flex justify-between items-end mb-6"><h2 class="text-2xl font-bold text-slate-800">검증 리포트</h2><button onclick="window.print()" class="bg-white border px-4 py-2 rounded shadow">PDF 출력</button></header>
                <div class="report-paper">
                    <div class="border-b-2 border-black pb-4 mb-8">
                        <h1 class="text-3xl font-bold font-serif text-center">Product Carbon Footprint Report</h1>
                        <p class="text-center text-sm mt-2 text-gray-500">According to ISO 14067 & EU PEFCR</p>
                    </div>
                    <div id="rep-content" class="text-sm"></div>
                </div>
            </section>
            
            <section id="tab-corporate" class="hidden fade-in max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">기업 정보 관리 (Enterprise)</h2>
                <div class="bg-white p-8 rounded-xl border shadow-sm">
                    <div class="flex gap-2 mb-6">
                        <input type="text" id="biz-no" class="input-field w-64 text-left" placeholder="사업자등록번호 (10자리)" maxlength="12">
                        <button onclick="fetchCorporateInfo()" class="bg-slate-800 text-white px-4 rounded font-bold">API 조회</button>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div><label class="text-xs font-bold text-slate-500">법인명 (API)</label><input id="corp-name" class="input-field bg-slate-50" readonly placeholder="조회 시 자동입력"></div>
                        <div><label class="text-xs font-bold text-slate-500">대표자 (API)</label><input id="corp-rep" class="input-field bg-slate-50" readonly placeholder="조회 시 자동입력"></div>
                        <div><label class="text-xs font-bold text-indigo-600">담당자 성명 (직접입력)</label><input id="corp-user" class="input-field bg-white border-indigo-300" placeholder="입력하세요"></div>
                        <div><label class="text-xs font-bold text-indigo-600">연락처 (직접입력)</label><input id="corp-tel" class="input-field bg-white border-indigo-300" placeholder="입력하세요"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="aiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center"><h3 class="font-bold">AI Smart Data Collector (Categorized)</h3><button onclick="closeAI()" class="text-white"><i class="fas fa-times"></i></button></div>
            <div class="flex-1 p-8 bg-slate-50 grid grid-cols-3 gap-4">
                <div class="col-span-1 border-2 border-dashed border-indigo-200 bg-white rounded-xl p-4 text-center drop-zone" ondrop="handleDrop(event, 'bom')" ondragover="allowDrop(event)">
                    <i class="fas fa-cube text-2xl text-indigo-400 mb-2"></i><h4 class="font-bold text-sm">1. BOM (자재)</h4><p class="text-xs text-gray-400">Excel/PDF</p>
                </div>
                <div class="col-span-1 border-2 border-dashed border-yellow-200 bg-white rounded-xl p-4 text-center drop-zone" ondrop="handleDrop(event, 'energy')" ondragover="allowDrop(event)">
                    <i class="fas fa-bolt text-2xl text-yellow-400 mb-2"></i><h4 class="font-bold text-sm">2. Energy (고지서)</h4><p class="text-xs text-gray-400">Img/PDF</p>
                </div>
                <div class="col-span-1 border-2 border-dashed border-green-200 bg-white rounded-xl p-4 text-center drop-zone" ondrop="handleDrop(event, 'logis')" ondragover="allowDrop(event)">
                    <i class="fas fa-truck text-2xl text-green-400 mb-2"></i><h4 class="font-bold text-sm">3. Logistics (필증)</h4><p class="text-xs text-gray-400">PDF</p>
                </div>
                <div class="col-span-3 bg-slate-900 rounded-xl p-4 text-xs font-mono text-green-400 h-40 overflow-y-auto" id="ai-preview">Waiting for categorized upload...</div>
            </div>
            <div class="p-6 bg-white border-t flex justify-end gap-3">
                <button onclick="closeAI()" class="px-4 py-2 text-slate-500 font-bold">취소</button>
                <button onclick="applyAI()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow">데이터 매핑 및 적용</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & INIT ---
        const catSel = document.getElementById('lca-cat');
        Object.keys(PEF_CATS).forEach(k => catSel.innerHTML += `<option value="${k}">${PEF_CATS[k].name}</option>`);
        const gridSel = document.getElementById('lca-grid');
        Object.keys(GRID_DB).forEach(k => gridSel.innerHTML += `<option value="${k}">${GRID_DB[k].name}</option>`);
        const packSel = document.getElementById('lca-pack');
        const packKeys = { 'ldpe': 'Polybag (LDPE)', 'box': 'Cardboard Box' };
        Object.keys(packKeys).forEach(k => packSel.innerHTML += `<option value="${k}">${packKeys[k]}</option>`);

        // --- 2. CORE FUNCTIONS ---
        function switchTab(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            if(id==='report') updateReport();
            if(id==='dashboard') updateCharts(); // Critical Fix for Canvas 0 size
        }

        function setDefaults() {
            const d = PEF_CATS[document.getElementById('lca-cat').value];
            // Official Defaults Logic
            document.getElementById('lca-wash').value = d.life; // Total washes in lifetime
            document.getElementById('lca-temp').value = d.wash_temp;
            document.getElementById('lca-iron').value = d.iron;
            calc();
        }

        function addBomRow() {
            const tbody = document.getElementById('bom-body');
            tbody.innerHTML += `<tr><td class="p-2"><select class="w-full border p-1 mat-select" onchange="calc()"><option value="cotton">Cotton</option><option value="poly">Polyester</option></select></td><td class="p-2"><select class="w-full border p-1 proc-select"><option value="spinning">Spinning</option><option value="sewing">Sewing</option></select></td><td class="p-2 text-right"><input type="number" class="w-20 border p-1 text-right weight-input" value="0.2" oninput="calc()"></td><td class="text-center"><button onclick="this.closest('tr').remove();calc()"><i class="fas fa-trash"></i></button></td></tr>`;
            calc();
        }

        function calc() {
            // 5-Stage ISO Logic
            // 1. Material
            let sumMat = 0;
            document.querySelectorAll('#bom-body tr').forEach(r => {
                const w = parseFloat(r.querySelector('.weight-input').value)||0;
                sumMat += w * 2.0; // Mock factor
            });

            // 2. Production
            const elec = parseFloat(document.getElementById('inp-elec').value)||0;
            const gas = parseFloat(document.getElementById('inp-gas').value)||0;
            const sumMfg = (elec * 0.478) + (gas * 0.2);

            // 3. Distribution
            const packW = parseFloat(document.getElementById('lca-pw').value)||0;
            const distKm = parseFloat(document.getElementById('lca-dist').value)||0;
            const sumDist = (packW * 1.5) + (0.25 * distKm * 0.001); // t-km logic

            // 4. Use Phase (Official Logic)
            const washes = parseFloat(document.getElementById('lca-wash').value)||0;
            const temp = parseFloat(document.getElementById('lca-temp').value)||0;
            const iron = parseFloat(document.getElementById('lca-iron').value)||0;
            // Energy = (0.2 + (temp-20)*0.01) per wash + Ironing
            const sumUse = (washes * (0.2 + (temp-20)*0.01)) + (iron * washes * 0.5);

            // 5. EOL
            const sumEol = 0.5; // Mock for demo

            const total = sumMat + sumMfg + sumDist + sumUse + sumEol;

            // Update UI
            document.getElementById('live-total').innerText = total.toFixed(2);
            document.getElementById('res-mat').innerText = sumMat.toFixed(2);
            document.getElementById('res-eng').innerText = sumMfg.toFixed(2);
            document.getElementById('res-dist').innerText = sumDist.toFixed(2);
            document.getElementById('res-use').innerText = sumUse.toFixed(2);
            document.getElementById('res-eol').innerText = sumEol.toFixed(2);

            window.appState.totalGWP = total;
            window.appState.breakdown = [sumMat, sumMfg, sumDist, sumUse, sumEol];
            
            if(window.donutChart) {
                window.donutChart.data.datasets[0].data = window.appState.breakdown;
                window.donutChart.update();
            }
        }

        // --- 3. AI & UPLOAD LOGIC ---
        function openAI() { document.getElementById('aiModal').classList.remove('hidden'); }
        function closeAI() { document.getElementById('aiModal').classList.add('hidden'); }
        function allowDrop(ev) { ev.preventDefault(); }
        
        function handleDrop(ev, type) {
            ev.preventDefault();
            const preview = document.getElementById('ai-preview');
            preview.innerHTML += `> Detected [${type.toUpperCase()}] File: ${ev.dataTransfer.files[0].name}<br>> Parsing standard format...<br>`;
        }

        function applyAI() {
            // Force Mapping (Official)
            document.getElementById('inp-elec').value = 2.5; // Energy file
            const tbody = document.getElementById('bom-body');
            tbody.innerHTML = `<tr><td class="p-2"><select class="w-full border p-1 mat-select"><option value="cotton">Cotton</option></select></td><td class="p-2"><select class="w-full border p-1 proc-select"><option value="spinning">Spinning</option></select></td><td class="p-2 text-right"><input type="number" class="w-20 border p-1 text-right weight-input" value="0.3" oninput="calc()"></td><td class="text-center">Del</td></tr>`;
            
            calc();
            closeAI();
            setTimeout(() => alert('AI: 분류된 데이터가 표준 항목에 매핑되었습니다.'), 100);
        }

        // --- 4. REPORT & CORPORATE ---
        function updateReport() {
            document.getElementById('rep-content').innerHTML = `
            <div class="border p-4 bg-gray-50">
                <h3 class="font-bold border-b pb-2 mb-2">1. System Boundary</h3>
                <p>Cradle-to-Grave (5 Stages)</p>
                <h3 class="font-bold border-b pb-2 mb-2 mt-4">2. Impact Assessment (GWP)</h3>
                <table class="w-full border collapse bg-white">
                    <tr><th class="border p-2">Total</th><td class="border p-2 font-bold">${document.getElementById('live-total').innerText} kgCO2e</td></tr>
                    <tr><td class="border p-2">Material</td><td class="border p-2">${document.getElementById('res-mat').innerText}</td></tr>
                    <tr><td class="border p-2">Production</td><td class="border p-2">${document.getElementById('res-eng').innerText}</td></tr>
                    <tr><td class="border p-2">Distribution</td><td class="border p-2">${document.getElementById('res-dist').innerText}</td></tr>
                    <tr><td class="border p-2">Use Phase</td><td class="border p-2">${document.getElementById('res-use').innerText}</td></tr>
                    <tr><td class="border p-2">End-of-Life</td><td class="border p-2">${document.getElementById('res-eol').innerText}</td></tr>
                </table>
            </div>`;
        }

        function fetchCorporateInfo() {
            // Hybrid Logic
            setTimeout(() => {
                document.getElementById('corp-name').value = '(주)한국지속가능성연구원';
                document.getElementById('corp-rep').value = '김주현';
                alert('공공데이터 조회 성공: 담당자 정보는 직접 입력해주세요.');
            }, 500);
        }

        function saveCalc() {
            const val = document.getElementById('live-total').innerText;
            const today = new Date().toISOString().split('T')[0];
            window.appState.history.unshift({ date: today, product: 'New Product', gwp: val });
            updateCharts();
            alert('저장 완료');
            switchTab('dashboard');
        }

        // --- 5. CHARTS (Resilient) ---
        const lineCtx = document.getElementById('lineChart');
        const donutCtx = document.getElementById('donutChart');
        
        window.lineChart = new Chart(lineCtx, { type: 'line', data: { labels: [], datasets: [{ label: 'History', data: [], borderColor: '#4f46e5', tension: 0.4 }] }, options: { maintainAspectRatio: false } });
        window.donutChart = new Chart(donutCtx, { type: 'doughnut', data: { labels: ['Mat','Mfg','Dist','Use','EOL'], datasets: [{ data: [], backgroundColor: ['#6366f1','#f59e0b','#10b981','#3b82f6','#64748b'] }] }, options: { maintainAspectRatio: false } });

        function updateCharts() {
            const sorted = [...window.appState.history].sort((a,b) => new Date(a.date)-new Date(b.date));
            window.lineChart.data.labels = sorted.map(h => h.date);
            window.lineChart.data.datasets[0].data = sorted.map(h => h.gwp);
            window.lineChart.update();

            window.donutChart.data.datasets[0].data = window.appState.breakdown;
            window.donutChart.update();
        }

        // Init
        addBomRow();
        setDefaults();
        updateCharts();
    </script>
</body>
</html>
