<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSIKR - Visual Fixed (v1200)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; }

        /* UI Components */
        .nav-item { padding: 12px; border-radius: 8px; color: #64748b; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .nav-item:hover { background: #f8fafc; color: #1e293b; }
        .nav-item.active { background: #e0e7ff; color: #4338ca; font-weight: 700; }
        
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        /* Map Fix: 높이 강제 지정 */
        #map-container { height: 100%; width: 100%; min-height: 350px; z-index: 1; border-radius: 8px; }
        
        /* Chart Fix */
        .chart-container { position: relative; height: 350px; width: 100%; }

        /* Animations */
        .scanner-line { position: absolute; width: 100%; height: 2px; background: #3b82f6; top: 0; animation: scan 1.5s infinite; display: none; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        .scanning .scanner-line { display: block; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="h-14 bg-slate-900 text-white flex items-center justify-between px-6 shrink-0 z-50">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 bg-indigo-600 rounded flex items-center justify-center font-bold text-lg">K</div>
            <h1 class="font-bold text-base">KSIKR <span class="text-slate-400 font-normal">v1200 (Visual Fixed)</span></h1>
        </div>
        <div class="text-xs bg-slate-800 px-3 py-1 rounded border border-slate-700">
            <i class="fas fa-satellite text-green-400 mr-2"></i>Map & Chart Online
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col p-4 z-40">
            <nav class="space-y-1">
                <div class="nav-item active" onclick="setTab('dash')" id="nav-dash"><i class="fas fa-chart-pie w-5 mr-2"></i> 대시보드</div>
                <div class="nav-item" onclick="setTab('lca')" id="nav-lca"><i class="fas fa-calculator w-5 mr-2"></i> 정밀 전과정평가</div>
                <div class="nav-item" onclick="setTab('report')" id="nav-report"><i class="fas fa-file-contract w-5 mr-2"></i> 인증 리포트</div>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto bg-slate-50 p-8 relative">

            <section id="tab-dash" class="space-y-6">
                <h2 class="text-2xl font-bold text-slate-900">Enterprise Dashboard</h2>
                
                <div class="grid grid-cols-4 gap-4">
                    <div class="card bg-slate-900 text-white border-0">
                        <div class="text-xs text-slate-400">Total GWP</div>
                        <div class="text-3xl font-bold mt-1"><span id="dash-total">0.00</span> <span class="text-sm">kgCO2e</span></div>
                    </div>
                    <div class="card"><div class="text-xs text-slate-500">Nodes</div><div class="text-xl font-bold mt-2">4 Active</div></div>
                    <div class="card"><div class="text-xs text-slate-500">DCI Score</div><div class="text-xl font-bold mt-2 text-green-600">A (High)</div></div>
                    <div class="card"><div class="text-xs text-slate-500">Hotspot</div><div class="text-xl font-bold mt-2 text-red-500">Vietnam</div></div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    
                    <div class="card flex flex-col h-[450px]"> 
                        <h3 class="font-bold text-sm mb-4">Stage Breakdown (Chart.js)</h3>
                        <div class="chart-container">
                            <canvas id="dashChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card flex flex-col h-[450px] p-0 overflow-hidden relative">
                        <div class="absolute top-4 left-4 z-[999] bg-white/90 px-3 py-1 rounded shadow text-xs font-bold">
                            Live Supply Chain (Leaflet)
                        </div>
                        <div id="map-container"></div>
                    </div>
                </div>
            </section>

            <section id="tab-lca" class="hidden max-w-6xl mx-auto space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">정밀 LCA 평가</h2>
                    <button onclick="runCalc()" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-indigo-700">Calculate & Sync</button>
                </div>

                <div class="grid grid-cols-12 gap-6">
                    <div class="col-span-8 space-y-6">
                        <div class="card relative">
                            <div class="flex justify-between mb-4">
                                <h3 class="font-bold text-sm">Upstream Input</h3>
                                <div id="btn-ocr" class="cursor-pointer text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded font-bold border border-blue-200">
                                    <i class="fas fa-camera mr-1"></i> AI OCR Scan
                                    <div class="scanner-line" id="ocr-scan-line"></div>
                                </div>
                            </div>
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-xs uppercase border-y"><tr><th>Item</th><th>Region</th><th class="text-right">Weight</th><th class="text-right">Impact</th><th></th></tr></thead>
                                <tbody id="upstream-list"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-span-4">
                        <div class="card bg-slate-900 text-white">
                            <h4 class="text-xs text-slate-400">Result Preview</h4>
                            <div class="text-3xl font-bold mt-2"><span id="res-total">0.00</span> kg</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tab-report" class="hidden">
                <div class="card max-w-4xl mx-auto min-h-[600px] p-12">
                    <h1 class="text-3xl font-bold border-b pb-4">Certification Report</h1>
                    <div class="mt-8 text-center bg-slate-50 p-8 rounded">
                        <div class="text-4xl font-bold"><span id="rpt-val">0.00</span> kgCO2e</div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES ---
        let MAP_INSTANCE = null;
        let CHART_INSTANCE = null;
        let UPSTREAM_ITEMS = [
            { name: 'Poly Fabric', region: 'CN', w: 0.3, impact: 0.45 },
            { name: 'Dyeing Process', region: 'VN', w: 0, impact: 0.675 }
        ];

        // --- 2. INITIALIZATION (On Load) ---
        window.onload = function() {
            console.log("System Init...");
            
            // 1. Init Chart
            initChart();
            
            // 2. Init Map (Wait 100ms to ensure container exists)
            setTimeout(initMap, 100);
            
            // 3. Initial Calc
            runCalc();
        };

        // --- 3. CHART LOGIC ---
        function initChart() {
            const ctx = document.getElementById('dashChart').getContext('2d');
            CHART_INSTANCE = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Upstream', 'Logistics', 'Use', 'EOL'],
                    datasets: [{
                        data: [1, 1, 1, 1], // Placeholder
                        backgroundColor: ['#4f46e5', '#f97316', '#22c55e', '#64748b'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, // 중요: 컨테이너 크기에 맞춤
                    cutout: '70%',
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // --- 4. MAP LOGIC ---
        function initMap() {
            // 이미 맵이 있으면 삭제 (재초기화 방지)
            if (MAP_INSTANCE) { MAP_INSTANCE.remove(); }

            // Create Map
            MAP_INSTANCE = L.map('map-container').setView([20, 105], 3); // Asia Focus

            // Add Tile Layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 18
            }).addTo(MAP_INSTANCE);

            // Add Default Markers
            addMapMarker(37.5665, 126.9780, 'red', 'Seoul (HQ)');
            addMapMarker(21.0285, 105.8542, 'orange', 'Vietnam (Mfg)');
            addMapMarker(31.2304, 121.4737, 'blue', 'China (Mat)');
            
            console.log("Map Initialized.");
        }

        function addMapMarker(lat, lng, color, title) {
            const colors = { red: '#ef4444', orange: '#f97316', blue: '#3b82f6', purple: '#8b5cf6' };
            L.circleMarker([lat, lng], {
                color: 'white',
                fillColor: colors[color] || '#333',
                fillOpacity: 1,
                radius: 8,
                weight: 2
            }).addTo(MAP_INSTANCE).bindPopup(`<b>${title}</b>`);
        }

        // --- 5. CALCULATION LOGIC ---
        function runCalc() {
            let upTotal = 0;
            UPSTREAM_ITEMS.forEach(i => upTotal += i.impact);
            
            // Simplified Downstream for Demo
            const dist = upTotal * 0.2;
            const use = upTotal * 0.4;
            const eol = upTotal * 0.1;
            const total = upTotal + dist + use + eol;

            // Text Update
            document.getElementById('dash-total').innerText = total.toFixed(2);
            document.getElementById('res-total').innerText = total.toFixed(2);
            document.getElementById('rpt-val').innerText = total.toFixed(2);

            // Chart Update
            if(CHART_INSTANCE) {
                CHART_INSTANCE.data.datasets[0].data = [upTotal, dist, use, eol];
                CHART_INSTANCE.update();
            }

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('upstream-list');
            tbody.innerHTML = '';
            UPSTREAM_ITEMS.forEach((i, idx) => {
                tbody.innerHTML += `
                    <tr class="border-b border-slate-100">
                        <td class="p-2">${i.name}</td>
                        <td class="p-2"><span class="bg-slate-100 px-1 rounded text-xs">${i.region}</span></td>
                        <td class="p-2 text-right">${i.w > 0 ? i.w : '-'}</td>
                        <td class="p-2 text-right font-bold">${i.impact.toFixed(2)}</td>
                        <td class="p-2 text-center text-xs cursor-pointer hover:text-red-500" onclick="delItem(${idx})"><i class="fas fa-trash"></i></td>
                    </tr>`;
            });
        }

        function delItem(idx) {
            UPSTREAM_ITEMS.splice(idx, 1);
            runCalc();
        }

        // --- 6. OCR SIMULATION ---
        document.getElementById('btn-ocr').addEventListener('click', () => {
            const btn = document.getElementById('btn-ocr');
            btn.classList.add('scanning');
            setTimeout(() => {
                btn.classList.remove('scanning');
                // Add India Data
                UPSTREAM_ITEMS.push({ name: 'Scanned: Cotton', region: 'IN', w: 0.5, impact: 0.6 });
                addMapMarker(19.0760, 72.8777, 'purple', 'Mumbai (New)');
                runCalc();
                alert("OCR Complete: India Data Added to Map & Calc");
            }, 1000);
        });

        // --- 7. TAB NAVIGATION ---
        function setTab(id) {
            // Hide all sections
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            
            // Active Menu Style
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-' + id).classList.add('active');

            // ★★★ CRITICAL FIX: MAP REFRESH ★★★
            // 지도가 숨겨졌다가 나올 때 크기를 재계산해야 깨지지 않음
            if (id === 'dash' && MAP_INSTANCE) {
                setTimeout(() => { 
                    MAP_INSTANCE.invalidateSize(); 
                }, 200); // 0.2초 뒤 강제 새로고침
            }
        }
    </script>
</body>
</html>
