<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSIKR - Enterprise ESG/LCA Platform (v99.0 Full Standard)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        
        /* UI Components */
        .nav-item { transition: all 0.2s; border-radius: 12px; font-weight: 600; color: #64748b; font-size: 14px; }
        .nav-item:hover { background-color: #f1f5f9; color: #334155; }
        .nav-active { background-color: #e0e7ff; color: #4338ca; box-shadow: 0 4px 6px -1px rgba(67, 56, 202, 0.1); }
        .kpi-card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .input-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 8px 12px; font-size: 13px; text-align: right; transition: all 0.2s; }
        .input-field:focus { border-color: #6366f1; outline: none; ring: 2px solid #e0e7ff; }
        .input-readonly { background-color: #f1f5f9; color: #64748b; cursor: not-allowed; }
        
        /* Report Style */
        .report-paper { width: 210mm; min-height: 297mm; padding: 20mm; margin: 0 auto; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; font-family: 'Times New Roman', serif; }
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
        .report-table th, .report-table td { border: 1px solid #000; padding: 6px; text-align: left; }
        .report-table th { background-color: #f3f4f6; font-weight: bold; }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <script>
        window.appState = {
            totalGWP: 0.00,
            breakdown: [0, 0, 0, 0, 0, 0], 
            history: [
                { date: '2025-11-20', product: 'Basic T-Shirt', gwp: 3.85, status: 'Certified' },
                { date: '2025-12-05', product: 'Denim Pants', gwp: 12.4, status: 'Draft' }
            ],
            suppliers: [
                { name: 'Dongjin Textile', item: 'Cotton Fabric', ef: 1.8 },
                { name: 'Taekwang Ind', item: 'Polyester', ef: 4.6 }
            ]
        };

        const PEF_CATS = {
            'tshirt': { name: 'T-Shirts (Knitted)', life: 2.0, wash: 52, temp: 40 },
            'shirt': { name: 'Shirts/Blouses (Woven)', life: 3.0, wash: 40, temp: 40 },
            'pants': { name: 'Trousers/Pants', life: 3.0, wash: 30, temp: 30 },
            'jeans': { name: 'Denim/Jeans', life: 4.0, wash: 20, temp: 30 },
            'coat': { name: 'Coats/Jackets', life: 5.0, wash: 5, temp: 30 },
            'shoes': { name: 'Footwear', life: 2.0, wash: 2, temp: 30 }
        };

        const GRID_DB = {
            'KR': { name: 'South Korea (IEA)', factor: 0.478 },
            'CN': { name: 'China (IEA Avg)', factor: 0.584 },
            'VN': { name: 'Vietnam (IGES)', factor: 0.450 },
            'EU': { name: 'EU Average (EEA)', factor: 0.250 },
            'US': { name: 'USA Average (EPA)', factor: 0.380 }
        };

        const MATERIAL_DB = {
            'cotton_conv': { name: 'Cotton (Conv)', ef: 1.8, waste: 0.05 },
            'poly_virgin': { name: 'Polyester (Virgin)', ef: 4.6, waste: 0.02 },
            'nylon': { name: 'Nylon 6.6', ef: 8.5, waste: 0.03 },
            'leather': { name: 'Leather', ef: 18.0, waste: 0.15 }
        };

        // Upstream Processing (Background Data)
        const PROCESS_DB = {
            'none': { name: 'None (Raw Material Only)', energy: 0 },
            'spinning': { name: 'Spinning/Weaving (Upstream)', energy: 3.5 },
            'dyeing': { name: 'Dyeing/Finishing (Upstream)', energy: 8.0 }
        };

        const PACK_DB = {
            'none': { name: 'None', ef: 0 },
            'ldpe': { name: 'Polybag (LDPE)', ef: 2.5 },
            'box': { name: 'Cardboard Box', ef: 0.8 }
        };
    </script>

    <div class="h-10 bg-slate-900 text-white flex items-center px-6 text-xs font-medium justify-between z-50 shadow-md shrink-0">
        <div class="flex items-center gap-4">
            <span class="bg-indigo-600 px-2 py-0.5 rounded text-[10px] font-bold tracking-wider">KSIKR OFFICIAL</span>
            <span class="text-slate-400">Standard: <span class="text-green-400">ISO 14067 / PEFCR 3.1</span></span>
        </div>
        <div class="flex items-center gap-4">
            <span class="flex items-center gap-2"><i class="fas fa-database text-slate-500"></i> DB: Ecoinvent 3.9</span>
            <span class="flex items-center gap-2"><i class="fas fa-user-circle text-slate-500"></i> Admin</span>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden h-full">
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-40">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-700 rounded-xl flex items-center justify-center text-white font-black text-xl shadow-lg shadow-indigo-200">K</div>
                <div><h1 class="text-lg font-extrabold text-slate-900 leading-tight">KSIKR <span class="text-indigo-600 font-medium">LCA</span></h1><p class="text-[10px] text-slate-400">SME ESG Solution</p></div>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <p class="px-3 text-[10px] font-bold text-slate-400 mt-4 mb-2 tracking-wider">WORKSPACE</p>
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 nav-active"><i class="fas fa-chart-line w-5 text-center"></i> ëŒ€ì‹œë³´ë“œ</button>
                <button onclick="switchTab('lca')" id="btn-lca" class="nav-item w-full flex items-center gap-3 px-4 py-3"><i class="fas fa-calculator w-5 text-center"></i> ì •ë°€ LCA ì‚°ì •</button>
                <button onclick="switchTab('report')" id="btn-report" class="nav-item w-full flex items-center gap-3 px-4 py-3"><i class="fas fa-file-contract w-5 text-center"></i> ì¸ì¦ ë¦¬í¬íŠ¸</button>
                <p class="px-3 text-[10px] font-bold text-slate-400 mt-8 mb-2 tracking-wider">DATA CENTER</p>
                <button onclick="switchTab('supply')" id="btn-supply" class="nav-item w-full flex items-center gap-3 px-4 py-3"><i class="fas fa-database w-5 text-center"></i> ê³µê¸‰ë§ ë°ì´í„°</button>
                <button onclick="switchTab('history')" id="btn-history" class="nav-item w-full flex items-center gap-3 px-4 py-3"><i class="fas fa-history w-5 text-center"></i> ì‚°ì • ì´ë ¥</button>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto relative scroll-smooth bg-slate-50 p-8">
            
            <section id="tab-dashboard" class="fade-in max-w-7xl mx-auto">
                <header class="flex justify-between items-end mb-8">
                    <div><h2 class="text-3xl font-bold text-slate-800">í†µí•© ê´€ì œ ëŒ€ì‹œë³´ë“œ</h2><p class="text-sm text-slate-500 mt-1">2025ë…„ ì—°ê°„ í™˜ê²½ ì„±ê³¼ ëª¨ë‹ˆí„°ë§</p></div>
                    <button onclick="switchTab('lca')" class="px-5 py-2.5 bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-indigo-700 transition-all"><i class="fas fa-plus mr-2"></i>ì‹ ê·œ í‰ê°€ ì‹œì‘</button>
                </header>
                <div class="grid grid-cols-4 gap-5 mb-8">
                    <div class="kpi-card"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500">AVG GWP</span><i class="fas fa-cloud text-indigo-200"></i></div><h3 class="text-2xl font-bold text-slate-800"><span id="dash-avg-gwp">8.12</span> <span class="text-sm text-slate-400">kg</span></h3></div>
                    <div class="kpi-card"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500">COMPLIANCE</span><i class="fas fa-shield-alt text-green-200"></i></div><h3 class="text-xl font-bold text-green-700">ESPR Ready</h3></div>
                    <div class="kpi-card"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500">CBAM RISK</span><i class="fas fa-exclamation-triangle text-yellow-200"></i></div><h3 class="text-2xl font-bold text-slate-800">Low</h3></div>
                    <div class="kpi-card"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-500">COST SAVING</span><i class="fas fa-won-sign text-blue-200"></i></div><h3 class="text-2xl font-bold text-slate-800">â‚© 12.5M</h3></div>
                </div>
                <div class="grid grid-cols-3 gap-6">
                    <div class="col-span-2 bg-white p-6 rounded-2xl border shadow-sm"><h4 class="font-bold text-slate-800 mb-4">ì›”ë³„ ë°°ì¶œëŸ‰ ì¶”ì´ (12ê°œì›”)</h4><div class="h-64"><canvas id="mainChart"></canvas></div></div>
                    <div class="col-span-1 bg-white p-6 rounded-2xl border shadow-sm"><h4 class="font-bold text-slate-800 mb-4">í•«ìŠ¤íŒŸ ë¶„ì„</h4><div class="h-64"><canvas id="donutChart"></canvas></div></div>
                </div>
            </section>

            <section id="tab-lca" class="hidden fade-in max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div><h2 class="text-2xl font-bold text-slate-800">ì •ë°€ ì „ê³¼ì •í‰ê°€ (LCA)</h2><p class="text-sm text-slate-500 mt-1">Scope 1, 2, 3 Full Coverage Calculation</p></div>
                </div>

                <div class="grid grid-cols-12 gap-8">
                    <div class="col-span-8 space-y-6 pb-20">
                        
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <h5 class="font-bold text-slate-800 mb-4 border-l-4 border-indigo-600 pl-3">1. ì œí’ˆ ì •ì˜ (Goal & Scope)</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500 block mb-1">ì¹´í…Œê³ ë¦¬</label>
                                    <select id="lca-cat" class="input-field bg-slate-50" onchange="setDefaults()"></select></div>
                                <div><label class="text-xs font-bold text-slate-500 block mb-1">ìƒì‚° êµ­ê°€ (Grid Mix)</label>
                                    <select id="lca-grid" class="input-field" onchange="calc()"></select></div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border shadow-sm overflow-hidden">
                            <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                                <h5 class="font-bold text-slate-800 border-l-4 border-indigo-600 pl-3 leading-none">2. ìì¬ëª…ì„¸ì„œ (Scope 3 Upstream)</h5>
                                <button onclick="addBomRow()" class="text-xs bg-white border border-indigo-200 text-indigo-700 px-3 py-1.5 rounded font-bold hover:bg-indigo-50 shadow-sm">+ ìì¬ ì¶”ê°€</button>
                            </div>
                            <table class="w-full text-sm text-left">
                                <thead class="bg-white text-xs text-slate-500 uppercase border-b">
                                    <tr><th class="px-6 py-3">ìì¬ (Material)</th><th>ë°°ê²½ ê³µì • (Background)</th><th class="text-right">ì¤‘ëŸ‰ (kg)</th><th class="text-center">ì‚­ì œ</th></tr>
                                </thead>
                                <tbody id="bom-body"></tbody>
                            </table>
                            <div class="p-3 bg-yellow-50 text-[11px] text-yellow-800 flex gap-2 items-center border-t border-yellow-100">
                                <i class="fas fa-info-circle"></i> ë°°ê²½ ê³µì •ì€ ì›ì¬ë£Œ ìƒì‚° ì‹œ ë°œìƒí•˜ëŠ” ê°„ì ‘ ë°°ì¶œ(Upstream)ì…ë‹ˆë‹¤.
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl border shadow-sm ring-1 ring-indigo-100">
                            <div class="flex justify-between items-center mb-4">
                                <h5 class="font-bold text-slate-800 border-l-4 border-indigo-600 pl-3">3. ì œì¡° ê³µì • ì—ë„ˆì§€ (Scope 1 & 2)</h5>
                                <span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold">Gate-to-Gate</span>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 block mb-1">ì‚°ì—…ìš© ì „ë ¥ (Electricity)</label>
                                    <div class="relative"><input type="number" id="inp-elec" class="input-field pr-12" value="0" min="0" oninput="calc()"><span class="absolute right-3 top-2 text-xs text-slate-400">kWh</span></div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 block mb-1">ë„ì‹œê°€ìŠ¤/LNG (Fuel)</label>
                                    <div class="relative"><input type="number" id="inp-gas" class="input-field pr-12" value="0" min="0" oninput="calc()"><span class="absolute right-3 top-2 text-xs text-slate-400">MJ</span></div>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 block mb-1">ê³µì—…ìš©ìˆ˜ (Water)</label>
                                    <div class="relative"><input type="number" id="inp-water" class="input-field pr-12" value="0" min="0" oninput="calc()"><span class="absolute right-3 top-2 text-xs text-slate-400">ton</span></div>
                                </div>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2">* ì œí’ˆ 1ë‹¨ìœ„ ìƒì‚°ì— íˆ¬ì…ëœ ì‹¤ì œ ì—ë„ˆì§€ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”. (ì „ë ¥ ë°°ì¶œê³„ìˆ˜ëŠ” ì„ íƒí•œ êµ­ê°€ Grid ìë™ ì ìš©)</p>
                        </div>

                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <h5 class="font-bold text-slate-800 mb-4 border-l-4 border-indigo-600 pl-3">4. í¬ì¥ ë° ë¬¼ë¥˜ (Packaging & Logistics)</h5>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label class="text-xs font-bold text-slate-500 block mb-1">í¬ì¥ì¬</label><select id="lca-pack" class="input-field" onchange="calc()"></select></div>
                                <div><label class="text-xs font-bold text-slate-500 block mb-1">í¬ì¥ ì¤‘ëŸ‰ (kg)</label><input type="number" id="lca-pweight" class="input-field" value="0.05" min="0" step="0.001" oninput="calc()"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 border-t pt-4">
                                <div><label class="text-xs font-bold text-slate-500 block mb-1">ìš´ì†¡ ìˆ˜ë‹¨/ê±°ë¦¬</label>
                                    <div class="flex gap-2">
                                        <select id="lca-mode" class="input-field w-1/2" onchange="calc()"><option value="ship">Ship</option><option value="air">Air</option><option value="road">Truck</option></select>
                                        <input type="number" id="lca-dist" class="input-field w-1/2" value="10000" min="0" oninput="calc()" placeholder="km">
                                    </div>
                                </div>
                                <div><label class="text-xs font-bold text-slate-500 block mb-1">ë§¤ì¥ ë³´ê´€ (ì¼)</label><input type="number" id="lca-retail" class="input-field" value="30" min="0" oninput="calc()"></div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <h5 class="font-bold text-slate-800 mb-4 border-l-4 border-indigo-600 pl-3">5. ì‚¬ìš© ë° íê¸° (Use & End-of-Life)</h5>
                            <div class="grid grid-cols-4 gap-4">
                                <div><label class="text-xs font-bold text-slate-500 block mb-1">ìˆ˜ëª… (ë…„)</label><input type="number" id="lca-life" class="input-field input-readonly" readonly></div>
                                <div><label class="text-xs font-bold text-slate-500 block mb-1">ì—°ê°„ ì„¸íƒ (íšŒ)</label><input type="number" id="lca-wash" class="input-field input-readonly" readonly></div>
                                <div><label class="text-xs font-bold text-indigo-600 block mb-1">ì„¸íƒ ì˜¨ë„ (â„ƒ)</label><input type="number" id="lca-temp" class="input-field font-bold text-indigo-700 bg-indigo-50" min="0" oninput="calc()"></div>
                                <div><label class="text-xs font-bold text-slate-500 block mb-1">íê¸° ë°©ì‹</label><select id="lca-eol-mode" class="input-field" onchange="calc()"><option value="landfill">ë§¤ë¦½</option><option value="incineration">ì†Œê°</option><option value="recycle">ì¬í™œìš©</option></select></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-span-4">
                        <div class="bg-slate-900 text-white rounded-xl p-6 shadow-xl sticky top-6">
                            <h5 class="text-xs font-bold text-slate-400 mb-4 tracking-widest">REAL-TIME GWP</h5>
                            <div class="text-4xl font-black mb-6"><span id="live-total">0.00</span> <span class="text-base font-normal text-slate-400">kgCO2e</span></div>
                            <div class="space-y-3 text-sm border-t border-slate-700 pt-4">
                                <div class="flex justify-between text-slate-300"><span>ğŸ§± Materials</span><span id="res-mat" class="font-mono text-white">0.00</span></div>
                                <div class="flex justify-between text-yellow-400 font-bold"><span>ğŸ­ Mfg Energy</span><span id="res-eng" class="font-mono">0.00</span></div>
                                <div class="flex justify-between text-slate-300"><span>ğŸ“¦ Pack/Logis</span><span id="res-log" class="font-mono text-white">0.00</span></div>
                                <div class="flex justify-between text-slate-300"><span>ğŸ‘• Use Phase</span><span id="res-use" class="font-mono text-white">0.00</span></div>
                                <div class="flex justify-between text-slate-300"><span>â™»ï¸ End of Life</span><span id="res-eol" class="font-mono text-white">0.00</span></div>
                            </div>
                            <button onclick="saveCalc()" class="w-full bg-indigo-600 hover:bg-indigo-500 mt-8 py-3 rounded-lg font-bold shadow-lg transition">ê²°ê³¼ í™•ì • ë° ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tab-report" class="hidden fade-in max-w-5xl mx-auto">
                <header class="flex justify-between items-end mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">ì¸ì¦ ë¦¬í¬íŠ¸</h2>
                    <button onclick="window.print()" class="bg-white border px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-slate-50"><i class="fas fa-print mr-2"></i>PDF ì¶œë ¥</button>
                </header>
                <div class="report-paper">
                    <div class="border-b-2 border-black pb-4 mb-8 flex justify-between items-end">
                        <h1 class="text-3xl font-bold font-serif">LCA VERIFICATION REPORT</h1>
                        <div class="text-right text-xs"><p>ISO 14067 / EU PEFCR</p><p>Doc ID: KSIKR-2025-009</p></div>
                    </div>
                    <div class="mb-8">
                        <h2 class="font-bold border-b border-gray-400 mb-2">1. GENERAL INFORMATION</h2>
                        <table class="report-table">
                            <tr><th width="30%">Product Category</th><td id="rep-cat">--</td></tr>
                            <tr><th>Production Location</th><td id="rep-grid">--</td></tr>
                            <tr><th>Scope</th><td>Cradle-to-Grave</td></tr>
                        </table>
                    </div>
                    <div class="mb-8">
                        <h2 class="font-bold border-b border-gray-400 mb-2">2. ENERGY INPUTS (Scope 1 & 2)</h2>
                        <table class="report-table">
                            <tr><th>Electricity</th><td id="rep-elec">-- kWh</td></tr>
                            <tr><th>Fuel (Gas)</th><td id="rep-gas">-- MJ</td></tr>
                            <tr><th>Water</th><td id="rep-water">-- ton</td></tr>
                        </table>
                    </div>
                    <div class="mb-8">
                        <h2 class="font-bold border-b border-gray-400 mb-2">3. IMPACT RESULTS (GWP)</h2>
                        <table class="report-table">
                            <tr style="background:#000; color:white;"><th>Impact Category</th><th>Unit</th><th>Result</th></tr>
                            <tr><td><strong>Climate Change</strong></td><td>kg CO2 eq</td><td class="font-bold text-lg" id="rep-total">--</td></tr>
                        </table>
                    </div>
                </div>
            </section>

            <section id="tab-supply" class="hidden fade-in max-w-6xl mx-auto">
                <header class="flex justify-between items-end mb-6"><div><h2 class="text-2xl font-bold text-slate-800">ê³µê¸‰ë§ ë°ì´í„°</h2></div><button class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow" onclick="alert('ì¤€ë¹„ì¤‘')">+ í˜‘ë ¥ì‚¬ ì¶”ê°€</button></header>
                <div class="bg-white rounded-xl shadow border overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b"><tr><th class="px-6 py-3">í˜‘ë ¥ì‚¬ëª…</th><th>ê³µê¸‰ ìì¬</th><th>ë°°ì¶œê³„ìˆ˜</th><th>ìƒíƒœ</th></tr></thead><tbody id="supply-body"></tbody></table></div>
            </section>
            <section id="tab-history" class="hidden fade-in max-w-6xl mx-auto">
                <header class="mb-6"><h2 class="text-2xl font-bold text-slate-800">ì‚°ì • ì´ë ¥</h2></header>
                <div class="bg-white rounded-xl shadow border overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b"><tr><th class="px-6 py-3">ë‚ ì§œ</th><th>ì œí’ˆëª…</th><th>ê²°ê³¼</th><th>ìƒíƒœ</th></tr></thead><tbody id="history-body"></tbody></table></div>
            </section>

        </main>
    </div>

    <script>
        // --- Init ---
        function init() {
            const catSel = document.getElementById('lca-cat');
            Object.keys(PEF_CATS).forEach(k => catSel.innerHTML += `<option value="${k}">${PEF_CATS[k].name}</option>`);
            
            const gridSel = document.getElementById('lca-grid');
            Object.keys(GRID_DB).forEach(k => gridSel.innerHTML += `<option value="${k}">${GRID_DB[k].name}</option>`);

            const packSel = document.getElementById('lca-pack');
            Object.keys(PACK_DB).forEach(k => packSel.innerHTML += `<option value="${k}">${PACK_DB[k].name}</option>`);

            loadSupply(); 
            loadHistory(); 
            renderCharts(); 
            addBomRow(); 
            setDefaults();
        }

        function switchTab(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active'));
            document.getElementById('btn-'+id).classList.add('nav-active');
        }

        // --- Core Logic ---
        function setDefaults() {
            const cat = document.getElementById('lca-cat').value;
            const data = PEF_CATS[cat];
            document.getElementById('lca-life').value = data.life;
            document.getElementById('lca-wash').value = data.wash;
            document.getElementById('lca-temp').value = data.temp;
            calc();
        }

        function addBomRow() {
            const tbody = document.getElementById('bom-body');
            const rowId = 'row-' + Date.now();
            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.className = "border-b hover:bg-slate-50";
            tr.innerHTML = `
                <td class="px-6 py-3"><select class="w-full p-2 border rounded text-sm bg-white mat-select" onchange="calc()">${Object.keys(MATERIAL_DB).map(k => `<option value="${k}">${MATERIAL_DB[k].name}</option>`).join('')}</select></td>
                <td><select class="w-full p-2 border rounded text-sm bg-white proc-select" onchange="calc()">${Object.keys(PROCESS_DB).map(k => `<option value="${k}">${PROCESS_DB[k].name}</option>`).join('')}</select></td>
                <td class="text-right"><input type="number" class="w-24 p-2 border rounded text-right text-sm weight-input" value="0.2" step="0.01" min="0" oninput="calc()"></td>
                <td class="text-center"><button onclick="document.getElementById('${rowId}').remove();calc()" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button></td>`;
            tbody.appendChild(tr);
            calc();
        }

        function calc() {
            const gridFactor = GRID_DB[document.getElementById('lca-grid').value].factor;

            // 1. Material & Background Process (Scope 3 Upstream)
            let sumMat = 0, totalMatWeight = 0;
            const matsUsed = [];
            document.querySelectorAll('#bom-body tr').forEach(r => {
                const w = parseFloat(r.querySelector('.weight-input').value) || 0;
                totalMatWeight += w;
                const m = MATERIAL_DB[r.querySelector('.mat-select').value];
                const p = PROCESS_DB[r.querySelector('.proc-select').value]; // Background Process
                
                // Mat EF + Background Energy * Grid (Estimating Upstream)
                sumMat += w * (m.ef * (1 + m.waste) + (p.energy * gridFactor));
                matsUsed.push(m.name);
            });

            // 2. Manufacturing Energy (Scope 1 & 2 - Gate to Gate) [ADDED]
            const elec = parseFloat(document.getElementById('inp-elec').value) || 0;
            const gas = parseFloat(document.getElementById('inp-gas').value) || 0;
            const water = parseFloat(document.getElementById('inp-water').value) || 0;

            const sumElec = elec * gridFactor; // Scope 2
            const sumGas = gas * 0.202; // Scope 1 (LNG approx 0.2 kgCO2e/MJ)
            const sumWater = water * 0.3; // Water footprint approx
            const sumEng = sumElec + sumGas + sumWater;

            // 3. Packaging & Logistics
            const packW = parseFloat(document.getElementById('lca-pweight').value) || 0;
            const sumPack = packW * PACK_DB[document.getElementById('lca-pack').value].ef;
            const isAir = document.getElementById('lca-mode').value === 'air';
            const sumLog = ((totalMatWeight + packW) / 1000) * parseFloat(document.getElementById('lca-dist').value || 0) * (isAir ? 0.6 : 0.015);

            // 4. Use Phase (Washing)
            const retail = parseFloat(document.getElementById('lca-retail').value || 0) * 0.05 * gridFactor;
            const life = parseFloat(document.getElementById('lca-life').value || 1);
            const wash = parseFloat(document.getElementById('lca-wash').value || 0);
            const temp = parseFloat(document.getElementById('lca-temp').value || 30);
            const energyPerWash = Math.max(0, 0.3 + ((temp - 30) * 0.015));
            const sumUse = retail + (life * wash * energyPerWash * gridFactor);

            // 5. EOL
            const eolMode = document.getElementById('lca-eol-mode').value;
            const eolFactor = (eolMode === 'recycle') ? -0.5 : (eolMode === 'incineration' ? 1.2 : 0.1);
            const sumEol = (totalMatWeight + packW) * eolFactor;

            // Total
            const total = Math.max(0, sumMat + sumEng + sumPack + sumLog + sumUse + sumEol);

            // UI Updates
            document.getElementById('live-total').innerText = total.toFixed(2);
            document.getElementById('res-mat').innerText = sumMat.toFixed(2);
            document.getElementById('res-eng').innerText = sumEng.toFixed(2); // New Line
            document.getElementById('res-log').innerText = (sumPack + sumLog).toFixed(2);
            document.getElementById('res-use').innerText = sumUse.toFixed(2);
            document.getElementById('res-eol').innerText = sumEol.toFixed(2);

            // Report Updates
            document.getElementById('rep-total').innerText = total.toFixed(2);
            document.getElementById('rep-cat').innerText = PEF_CATS[document.getElementById('lca-cat').value].name;
            document.getElementById('rep-grid').innerText = GRID_DB[document.getElementById('lca-grid').value].name;
            document.getElementById('rep-elec').innerText = elec.toFixed(1) + " kWh";
            document.getElementById('rep-gas').innerText = gas.toFixed(1) + " MJ";
            document.getElementById('rep-water').innerText = water.toFixed(1) + " ton";

            window.appState.totalGWP = total;
            window.appState.breakdown = [sumMat, sumEng, sumPack + sumLog, sumUse, Math.max(0, sumEol), 0];
            updateCharts();
        }

        // --- Charts & Common ---
        function saveCalc() {
            const val = document.getElementById('live-total').innerText;
            const currentTotal = window.appState.history.reduce((acc, curr) => acc + parseFloat(curr.gwp), 0);
            const newAvg = ((currentTotal + parseFloat(val)) / (window.appState.history.length + 1)).toFixed(2);
            document.getElementById('dash-avg-gwp').innerText = newAvg;
            window.appState.history.unshift({ date: new Date().toISOString().split('T')[0], product: 'New Product', gwp: val, status: 'Draft' });
            loadHistory(); alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); switchTab('history');
        }
        function loadSupply() { document.getElementById('supply-body').innerHTML = window.appState.suppliers.map(s => `<tr class="border-b"><td class="px-6 py-4">${s.name}</td><td>${s.item}</td><td class="font-mono text-indigo-600">${s.ef}</td><td>Active</td></tr>`).join(''); }
        function loadHistory() { document.getElementById('history-body').innerHTML = window.appState.history.map(h => `<tr class="border-b"><td class="px-6 py-4">${h.date}</td><td class="font-bold">${h.product}</td><td class="font-bold">${h.gwp}</td><td>${h.status}</td></tr>`).join(''); }
        
        let donutChart, mainChart;
        function renderCharts() {
            donutChart = new Chart(document.getElementById('donutChart'), { type: 'doughnut', data: { labels: ['Mat','Mfg','Logis','Use','EOL'], datasets: [{ data: [1,1,1,1,1], backgroundColor: ['#4f46e5','#f59e0b','#10b981','#3b82f6','#64748b'], borderWidth:0 }] }, options: { cutout:'70%', plugins:{legend:{display:false}} } });
            mainChart = new Chart(document.getElementById('mainChart'), { type: 'line', data: { labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'], datasets: [{ data:[12,19,15,22,18,25,30,28,24,20,18,22], borderColor:'#4f46e5', tension:0.4, fill:true, backgroundColor:'rgba(79, 70, 229, 0.05)' }] }, options: { maintainAspectRatio:false, plugins:{legend:{display:false}} } });
        }
        function updateCharts() { if(donutChart) { donutChart.data.datasets[0].data = window.appState.breakdown.slice(0,5); donutChart.update(); } }
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
