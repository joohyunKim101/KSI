<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSIKR - SME íŠ¹í™” ESG/LCA í†µí•© í”Œë«í¼ (v72.0 Final Gold)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .nav-active { background-color: #f0f9ff; color: #0369a1; border-right: 3px solid #0284c7; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal-bg { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .toggle-btn { transition: all 0.2s; }
        .toggle-btn.active { background-color: #ffffff; color: #4f46e5; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .upload-zone { border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        .upload-zone:hover { border-color: #4f46e5; background-color: #f5f3ff; }
        .scan-line { width: 100%; height: 2px; background: #4f46e5; box-shadow: 0 0 10px #4f46e5; position: absolute; animation: scan 1.5s infinite; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
        .status-badge { @apply px-2 py-1 rounded text-xs font-bold flex items-center gap-1; }
        .ticker-wrap { width: 100%; overflow: hidden; background-color: #1e293b; color: white; height: 30px; line-height: 30px; }
        .ticker { display: inline-block; white-space: nowrap; padding-right: 100%; box-sizing: content-box; animation: ticker 30s linear infinite; }
        .ticker__item { display: inline-block; padding: 0 2rem; font-size: 0.75rem; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        .proxy-data { background-color: #fef9c3 !important; border-color: #facc15 !important; color: #854d0e !important; }
        /* Report Styles */
        .report-de { font-family: 'Arial', sans-serif; border: 1px solid #333; padding: 20px; background: #fff; }
        .report-kr { font-family: 'Malgun Gothic', sans-serif; border: 3px double #22c55e; padding: 20px; background: #fdfdfd; }
        .report-uk { font-family: 'Courier New', monospace; border: 2px solid #000; padding: 20px; background: #fff; }
        .report-fr { font-family: sans-serif; border: 1px solid #ddd; padding: 20px; background: #f9f9f9; border-left: 5px solid #22c55e; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="expert-mode" class="h-full flex flex-col transition-opacity duration-500 bg-slate-50 z-40">
        <div class="ticker-wrap flex items-center shrink-0">
            <div class="bg-indigo-600 px-3 text-xs font-bold z-10 flex items-center gap-2 h-full">
                <i class="fas fa-satellite-dish animate-pulse"></i> Global Reg-Watch
            </div>
            <div class="ticker">
                <div class="ticker__item"><i class="fas fa-check-double text-green-400 mr-1"></i> [FINAL VALIDATION] ISO 14040/14044 & PEFCR Logic Verified</div>
                <div class="ticker__item"><i class="fas fa-water text-blue-400 mr-1"></i> [WATER FIX] AWARE Factor Regionalization (Sourcing Linked) Applied</div>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-20 shadow-sm">
                <div class="p-5 border-b border-slate-100 flex items-center gap-3">
                    <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">K</div>
                    <div><h1 class="text-lg font-bold text-slate-800">KSIKR <span class="text-xs font-normal text-slate-500">Pro</span></h1></div>
                </div>
                <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
                    <p class="px-3 py-2 text-[10px] font-bold text-slate-400 mt-2">DASHBOARD</p>
                    <button onclick="switchTab('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors nav-active"><i class="fas fa-chart-pie w-5 text-center"></i> í†µí•© ê´€ì œ ì„¼í„°</button>
                    <p class="px-3 py-2 text-[10px] font-bold text-slate-400 mt-4">CORE FEATURES</p>
                    <button onclick="switchTab('lca')" id="nav-lca" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors"><i class="fas fa-tshirt w-5 text-center"></i> ì œí’ˆ PEF/LCA í‰ê°€</button>
                    <button onclick="switchTab('compliance')" id="nav-compliance" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors"><i class="fas fa-passport w-5 text-center"></i> ê·œì œ & ë³´ê³ ì„œ</button>
                    <button onclick="switchTab('supply')" id="nav-supply" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors"><i class="fas fa-truck-loading w-5 text-center"></i> ê³µê¸‰ë§ ë°ì´í„°</button>
                    <p class="px-3 py-2 text-[10px] font-bold text-slate-400 mt-4">SETTINGS</p>
                    <button onclick="openSettingsModal()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors hover:text-indigo-600"><i class="fas fa-cog w-5 text-center"></i> ê¸°ì—… ì •ë³´ ì„¤ì •</button>
                </nav>
            </aside>

            <main class="flex-1 overflow-y-auto bg-slate-50/50 p-6 md:p-8">
                <section id="dashboard" class="fade-in max-w-7xl mx-auto">
                    <header class="flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800"><span id="header-company-name">(ì£¼)ëŒ€ì„±ì‹ ë°œ</span> Dashboard</h2>
                            <p class="text-sm text-slate-500 mt-1">LCA Master (v72.0 Final Gold)</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="downloadReport(this)" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 shadow-sm flex items-center transition-all"><i class="fas fa-download mr-2"></i>ì›”ê°„ ë¦¬í¬íŠ¸</button>
                            <button onclick="toggleMode('simple'); resetSimple();" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-lg"><i class="fas fa-plus mr-2"></i>ì‹ ê·œ ë“±ë¡</button>
                        </div>
                    </header>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2"><p class="text-xs text-slate-500 font-bold uppercase">Carbon (GWP)</p><span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded font-bold">ISO 14067</span></div>
                            <h3 class="text-2xl font-bold text-slate-800"><span id="total-carbon-display">--</span> <span class="text-sm font-normal text-slate-500">kgCO2e</span></h3>
                            <p class="text-[11px] text-slate-400 mt-2">Drying & Air-Freight Logic Fixed</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2"><p class="text-xs text-slate-500 font-bold uppercase">PEF Score</p><span class="text-indigo-600 text-xs"><i class="fas fa-medal"></i> Class B</span></div>
                            <h3 class="text-2xl font-bold text-slate-800">88<span class="text-sm text-slate-400">/100</span></h3>
                            <p class="text-[11px] text-slate-400 mt-2">Methodology Verified</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2"><p class="text-xs text-slate-500 font-bold uppercase">Total Waste</p><i class="fas fa-trash-alt text-slate-400"></i></div>
                            <h3 class="text-2xl font-bold text-slate-800"><span id="dashboard-waste">--</span> <span class="text-sm font-normal text-slate-500">kg</span></h3>
                            <p class="text-[11px] text-slate-400 mt-2">Deadstock Disposal Included</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2"><p class="text-xs text-slate-500 font-bold uppercase">Water Scarcity</p><i class="fas fa-tint text-blue-400"></i></div>
                            <h3 class="text-2xl font-bold text-slate-800"><span id="dashboard-water">--</span> <span class="text-sm font-normal text-slate-500">mÂ³eq</span></h3>
                            <p class="text-[11px] text-slate-400 mt-2">Regionalized AWARE (ISO 14046)</p>
                        </div>

                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-5 rounded-xl shadow-lg">
                            <div class="flex justify-between items-start mb-2"><p class="text-xs text-slate-300 font-bold uppercase">Target Market</p><span class="bg-white/20 text-white text-[10px] px-2 py-0.5 rounded">Global</span></div>
                            <div class="space-y-1 mt-2">
                                <div class="flex justify-between text-xs"><span>EU:</span> <span class="text-green-400">PEF / ESPR</span></div>
                                <div class="flex justify-between text-xs"><span>UK:</span> <span class="text-yellow-300">Green Claims</span></div>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2"><p class="text-xs text-slate-500 font-bold uppercase">Data Quality (DQR)</p><i class="fas fa-database text-indigo-400"></i></div>
                            <h3 class="text-2xl font-bold text-slate-800" id="dqr-score">-- <span class="text-sm font-normal text-slate-500">/ 5.0</span></h3>
                            <div class="flex gap-1 mt-2"><span class="text-[9px] bg-indigo-50 text-indigo-600 px-1 rounded">Dynamic GeR</span></div>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2"><p class="text-xs text-slate-500 font-bold uppercase">Circularity</p><i class="fas fa-sync text-green-500"></i></div>
                            <div class="flex items-end gap-2"><h3 class="text-2xl font-bold text-slate-800" id="mci-grade">--</h3><span class="text-[10px] bg-green-100 text-green-700 px-1 rounded mb-1" id="mci-score">MCI --</span></div>
                            <p class="text-[11px] text-slate-400 mt-2">R1/R2 Optimized</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2"><p class="text-xs text-slate-500 font-bold uppercase">Compliance</p><span class="text-xs bg-indigo-50 text-indigo-700 px-1 rounded font-bold">Ready</span></div>
                            <div class="space-y-1 mt-2"><div class="flex justify-between text-[11px] text-slate-500"><span>German LkSG:</span> <span class="text-green-500">OK</span></div><div class="flex justify-between text-[11px] text-slate-500"><span>Korea Eco:</span> <span class="text-green-500">OK</span></div></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-slate-700">PEF í™˜ê²½ ì˜í–¥ ë¶„ì„ (16ëŒ€ ë²”ì£¼ / 12ê°œì›”)</h4>
                                <div class="bg-slate-100 p-1 rounded-lg flex text-xs font-bold">
                                    <button onclick="updateChartType('monthly')" id="btn-monthly" class="toggle-btn active px-3 py-1.5 rounded-md bg-white text-indigo-600 shadow-sm">ì›”ë³„ ì¶”ì´</button>
                                    <button onclick="updateChartType('radar')" id="btn-accumulated" class="toggle-btn px-3 py-1.5 rounded-md text-slate-500">16ëŒ€ ë²”ì£¼ (Full)</button>
                                </div>
                            </div>
                            <div class="relative h-80 w-full flex justify-center"><canvas id="emissionsChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                            <h4 class="font-bold text-slate-700 mb-4">êµ­ê°€ë³„ ê·œì œ ë¦¬ìŠ¤í¬</h4>
                            <div class="flex-1 space-y-4 overflow-y-auto pr-2">
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100"><div class="flex items-center gap-3"><img src="https://flagcdn.com/w40/gb.png" class="w-8 h-5 shadow-sm rounded-sm"><div><p class="text-sm font-bold text-slate-800">UK (PPT)</p><p class="text-[10px] text-slate-500">Packaging Check</p></div></div><span class="status-badge bg-yellow-100 text-yellow-700"><i class="fas fa-exclamation-circle mr-1"></i> Action</span></div>
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100"><div class="flex items-center gap-3"><img src="https://flagcdn.com/w40/fr.png" class="w-8 h-5 shadow-sm rounded-sm"><div><p class="text-sm font-bold text-slate-800">France (AGEC)</p><p class="text-[10px] text-slate-500">Traceability Pass</p></div></div><span class="status-badge bg-green-100 text-green-700"><i class="fas fa-check mr-1"></i> Pass</span></div>
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100"><div class="flex items-center gap-3"><img src="https://flagcdn.com/w40/de.png" class="w-8 h-5 shadow-sm rounded-sm"><div><p class="text-sm font-bold text-slate-800">Germany (LkSG)</p><p class="text-[10px] text-slate-500">Due Diligence</p></div></div><span class="status-badge bg-green-100 text-green-700"><i class="fas fa-check mr-1"></i> Pass</span></div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="lca" class="hidden fade-in max-w-6xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <div><h3 class="text-lg font-bold text-slate-800">PEF ì „ê³¼ì •í‰ê°€ (Zero-Defect Logic)</h3><p class="text-sm text-slate-500">í†µí•© ë°ì´í„° ì—‘ì…€(BOM+ê³µì •) ì—…ë¡œë“œ â†’ AI ìë™ ë§¤í•‘ â†’ ì†ì‹¤ë¥ (Scrap) ë³´ì •</p></div>
                            <div class="flex gap-2">
                                <button onclick="downloadTemplate()" class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-colors shadow-sm"><i class="fas fa-download mr-2"></i>ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                                <label for="bomUpload" class="cursor-pointer px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 shadow flex items-center gap-2 transition-colors"><i class="fas fa-file-excel"></i> í†µí•© ë°ì´í„° ì—…ë¡œë“œ</label>
                                <input type="file" id="bomUpload" class="hidden" onchange="handleBomUpload()">
                            </div>
                        </div>

                        <div id="lca-workspace" class="hidden p-6 grid grid-cols-1 md:grid-cols-12 gap-8">
                            <div class="md:col-span-8 space-y-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                                        <label class="block text-xs font-bold text-indigo-800 mb-1">1. ì ìš© ê·œì¹™ (Auto)</label>
                                        <select id="pefcrSelect" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm bg-white"><option value="footwear" selected>Footwear (ì‹ ë°œ)</option><option value="apparel">Apparel (ì˜ë¥˜)</option></select>
                                    </div>
                                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                        <label class="block text-xs font-bold text-slate-600 mb-1">2. ìƒì‚° êµ­ê°€ (Origin)</label>
                                        <select id="prodCountry" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white" onchange="handleGridChange()"></select>
                                        <div class="mt-2">
                                            <label class="block text-[10px] font-bold text-slate-500 mb-1">ì›ë¶€ìì¬ ì¡°ë‹¬ (Sourcing)</label>
                                            <select id="sourcingSelect" class="w-full border border-slate-300 rounded-lg p-2 text-xs bg-white" onchange="updateRequirements()">
                                                <option value="local">ë¡œì»¬ (Domestic)</option>
                                                <option value="regional" selected>ê¶Œì—­ ë‚´ (Regional)</option>
                                                <option value="global">ê¸€ë¡œë²Œ (Global - Includes Drayage)</option>
                                            </select>
                                        </div>
                                        <div id="customGridWrapper" class="hidden mt-2"><input type="number" id="customGridFactor" class="w-full border border-indigo-300 rounded-lg p-2 text-sm" placeholder="ê³„ìˆ˜ ì…ë ¥"></div>
                                    </div>
                                </div>

                                <div class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm">
                                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center">
                                        <h5 class="text-sm font-bold text-slate-700">3. ìì¬ ë§¤í•‘ ê²€ìˆ˜ (BOM Verification)</h5>
                                        <div class="flex gap-2 items-center">
                                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-bold">AI Mapped</span>
                                            <button onclick="fillMissingData()" class="px-2 py-1 bg-white border border-yellow-300 text-yellow-600 rounded text-xs font-bold hover:bg-yellow-50"><i class="fas fa-magic mr-1"></i>ë¹ˆì¹¸ ì±„ìš°ê¸°</button>
                                        </div>
                                    </div>
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-slate-100 text-xs text-slate-500 uppercase">
                                            <tr>
                                                <th class="px-4 py-2">BOM ìì¬ëª…</th>
                                                <th class="px-4 py-2">LCI DB ë§¤í•‘ (AI ì¶”ì²œ)</th>
                                                <th class="px-4 py-2 text-right">Net ì¤‘ëŸ‰(kg)</th>
                                                <th class="px-4 py-2 text-center" title="ê³µì • ì†ì‹¤ë¥ ">ì†ì‹¤(%)</th>
                                                <th class="px-4 py-2 text-center">R1(%)</th>
                                                <th class="px-4 py-2 text-center">í™•ì¸</th>
                                            </tr>
                                        </thead>
                                        <tbody id="material-review-body" class="divide-y divide-slate-100"></tbody>
                                    </table>
                                    <div class="p-3 bg-slate-50 border-t border-slate-200 flex justify-end">
                                        <button onclick="addMaterialRow()" class="text-xs text-indigo-600 font-bold hover:text-indigo-800 flex items-center"><i class="fas fa-plus-circle mr-1"></i> ìˆ˜ë™ ì¶”ê°€ (Manual Add)</button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-3">
                                        <h5 class="text-xs font-bold text-slate-500 border-b pb-2 mb-2">4. ê³µì • (Manufacturing) - Auto</h5>
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">ê³µì • ì „ë ¥ (Scope 2)</label><div class="flex items-center gap-1"><input type="number" id="elecInput" class="w-16 text-right border rounded p-1 text-xs bg-white" placeholder="ì›”ê°„ì´ëŸ‰/ìƒì‚°ëŸ‰"><span class="text-[10px]">kWh/pc</span></div></div>
                                        
                                        <div class="flex justify-between items-center text-green-700 bg-green-50 p-1 rounded mb-1"><label class="text-xs font-bold">ì¬ìƒì—ë„ˆì§€ ì‚¬ìš© (RE100)</label><div class="flex items-center gap-1"><input type="number" id="renewableInput" class="w-12 text-right border border-green-300 rounded p-1 text-xs bg-white" placeholder="0" max="100"><span class="text-[10px]">%</span></div></div>

                                        <div class="flex flex-col gap-1">
                                            <div class="flex justify-between items-center text-red-600"><label class="text-xs font-bold">ê³µì • ì—´ì—ë„ˆì§€ (Scope 1)</label><div class="flex items-center gap-1"><input type="number" id="gasInput" class="w-16 text-right border border-red-200 rounded p-1 text-xs bg-white" placeholder="0"><span class="text-[10px]">MJ/pc</span></div></div>
                                            <div class="flex justify-between items-center">
                                                <label class="text-[10px] text-slate-500 pl-1">â”” ì—°ë£Œì› (Fuel)</label>
                                                <select id="fuelSource" class="w-24 border rounded p-1 text-[10px] bg-white text-slate-700">
                                                    <option value="0.056" selected>ì²œì—°ê°€ìŠ¤ (LNG)</option>
                                                    <option value="0.096">ì„íƒ„ (Coal)</option>
                                                    <option value="0.078">ì¤‘ìœ  (Fuel Oil)</option>
                                                    <option value="0.005">ë°”ì´ì˜¤ë§¤ìŠ¤</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="flex justify-between items-center text-purple-700 mt-1"><label class="text-xs font-bold">í™”í•™ë¬¼ì§ˆ (Chem)</label><div class="flex items-center gap-1"><input type="number" id="chemInput" class="w-16 text-right border border-purple-200 rounded p-1 text-xs bg-white" placeholder="0"><span class="text-[10px]">kg/pc</span></div></div>
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">ê³µì • ìš©ìˆ˜</label><div class="flex items-center gap-1"><input type="number" id="waterInput" class="w-16 text-right border rounded p-1 text-xs bg-white"><span class="text-[10px]">L/pc</span></div></div>
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">ê¸°íƒ€ íê¸°ë¬¼</label><div class="flex items-center gap-1"><input type="number" id="wasteInput" class="w-16 text-right border rounded p-1 text-xs bg-white"><span class="text-[10px]">kg/pc</span></div></div>
                                    </div>
                                    
                                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-3">
                                        <h5 class="text-xs font-bold text-slate-500 border-b pb-2 mb-2">5. í¬ì¥ ë° ë¬¼ë¥˜ (Pkg & Logi) - Auto</h5>
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">í”Œë¼ìŠ¤í‹± í¬ì¥</label><div class="flex items-center gap-1"><input type="number" id="pkgPlasticInput" class="w-16 text-right border rounded p-1 text-xs bg-white"><span class="text-[10px]">kg</span></div></div>
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">ì¢…ì´ í¬ì¥</label><div class="flex items-center gap-1"><input type="number" id="pkgPaperInput" class="w-16 text-right border rounded p-1 text-xs bg-white"><span class="text-[10px]">kg</span></div></div>
                                        
                                        <div class="flex justify-between items-center border-t pt-1">
                                            <label class="text-xs text-slate-600 font-bold">ìœ í†µ ì±„ë„</label>
                                            <select id="distChannel" class="w-24 border rounded p-1 text-xs bg-white text-indigo-700 font-bold">
                                                <option value="retail">ì˜¤í”„ë¼ì¸ ë§¤ì¥</option>
                                                <option value="online">ì˜¨ë¼ì¸ (E-com)</option>
                                                <option value="omni">ì˜´ë‹ˆì±„ë„</option>
                                            </select>
                                        </div>
                                        <div class="text-[10px] text-red-500 text-right italic" id="return-rate-display">ë°˜í’ˆë¥  ìë™ ì ìš©: 1%</div>

                                        <div class="flex justify-between items-center pt-1"><label class="text-xs text-slate-600">êµ­ì œ ìš´ì†¡</label>
                                            <select id="transMode" class="w-24 border rounded p-1 text-xs bg-white">
                                                <option value="sea">í•´ìƒ (Sea)</option>
                                                <option value="air">í•­ê³µ (Air)</option>
                                                <option value="road">ìœ¡ìƒ (Truck)</option>
                                            </select>
                                        </div>
                                        <div class="flex justify-between items-center"><label class="text-xs text-slate-600">ë‚´ë¥™/êµ­ì œ ê±°ë¦¬</label><div class="flex items-center gap-1"><input type="number" id="inlandDist" value="100" class="w-10 text-right border rounded p-1 text-[10px]" title="Inland"><span class="text-[9px] text-slate-400">/</span><input type="number" id="transportInput" class="w-14 text-right border rounded p-1 text-[10px] bg-slate-100 text-slate-500" readonly></div></div>
                                    </div>
                                </div>

                                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 flex justify-between items-center relative">
                                    <div>
                                        <h5 class="text-xs font-bold text-slate-500">6. ì‚¬ìš© ë‹¨ê³„ (Use Phase)</h5>
                                        <p class="text-[10px] text-indigo-600 font-bold"><i class="fas fa-check-circle mr-1"></i>EU PEFCR í‘œì¤€ ì‹œë‚˜ë¦¬ì˜¤ ìë™ ì ìš©</p>
                                    </div>
                                    <div class="flex items-center gap-2 opacity-100" title="ì„¸íƒ ì˜¨ë„ ì„ íƒ">
                                        <select id="washTemp" class="border rounded p-1 text-xs bg-white font-bold text-indigo-600">
                                            <option value="20">ëƒ‰ìˆ˜(20â„ƒ)</option>
                                            <option value="30">ë¯¸ì˜¨(30â„ƒ)</option>
                                            <option value="40" selected>ì˜¨ìˆ˜(40â„ƒ)</option>
                                            <option value="60">ê³ ì˜¨(60â„ƒ)</option>
                                        </select>
                                        <input type="number" id="washInput" value="50" class="w-12 text-right border rounded p-1 text-sm bg-gray-50" readonly><span class="text-xs">íšŒ</span>
                                    </div>
                                    <div class="absolute -top-2 -right-2 bg-blue-600 text-white text-[9px] px-2 py-0.5 rounded-full shadow">Auto-Set</div>
                                </div>

                                <button onclick="calculatePEF()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-md flex justify-center items-center gap-2 transition-all active:scale-95">
                                    <i class="fas fa-check-circle"></i> ê²€ìˆ˜ ì™„ë£Œ ë° ê²°ê³¼ ì‚°ì¶œ
                                </button>
                            </div>

                            <div class="md:col-span-4 bg-slate-50 p-5 rounded-lg border border-slate-200">
                                <h5 class="text-sm font-bold text-slate-700 mb-4 border-b border-slate-200 pb-2">PEF ê²°ê³¼ (16ëŒ€ ë²”ì£¼)</h5>
                                <div id="pef-results" class="space-y-3 opacity-50"><div class="text-center py-20 text-slate-400 text-xs"><i class="fas fa-file-excel text-3xl mb-2 text-green-600"></i><br>BOM íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´<br>AIê°€ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.</div></div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="compliance" class="hidden fade-in max-w-7xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm md:col-span-1 h-fit">
                            <div class="mb-6"><h3 class="text-lg font-bold text-slate-800 mb-2">ê·œì œ ë¦¬í¬íŠ¸ ìë™ ìƒì„±</h3><p class="text-xs text-slate-500">LCA ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµ­ê°€ë³„ ì–‘ì‹ ìë™ ë§¤í•‘</p></div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">íƒ€ê²Ÿ êµ­ê°€ ì„ íƒ (Destination)</label>
                                    <select id="targetCountry" class="w-full border border-slate-300 rounded p-2 text-sm" onchange="updateRequirements()">
                                        </select>
                                </div>
                                <div id="req-list" class="bg-slate-50 p-3 rounded-lg border border-slate-200 text-sm space-y-2"></div>
                                <button onclick="generateReport()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-md transition-all active:scale-95"><i class="fas fa-magic mr-2"></i> ë¦¬í¬íŠ¸ ìƒì„±</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm md:col-span-2">
                            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h4 class="font-bold text-slate-700">ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸° (Dynamic)</h4><div class="flex gap-2"><button onclick="printReport()" class="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded transition-colors">PDF / ì¶œë ¥</button></div></div>
                            <div id="report-content" class="bg-slate-50 border border-slate-200 rounded p-6 min-h-[400px] text-sm font-mono text-slate-600 relative overflow-hidden"></div>
                        </div>
                    </div>
                </section>
                
                <section id="supply" class="hidden fade-in max-w-7xl mx-auto"><div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6"><div class="flex justify-between items-center mb-6"><div><h3 class="text-lg font-bold text-slate-800">ê³µê¸‰ë§ ë°ì´í„° í¬í„¸ (Scope 3)</h3></div><button onclick="openRequestModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-md"><i class="fas fa-paper-plane mr-2"></i>ë°ì´í„° ìš”ì²­ ë°œì†¡</button></div><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-xs text-slate-500 uppercase"><tr><th class="px-4 py-3">í˜‘ë ¥ì‚¬</th><th class="px-4 py-3">í’ˆëª©</th><th class="px-4 py-3">ìƒíƒœ</th><th class="px-4 py-3">ì•¡ì…˜</th></tr></thead><tbody class="divide-y divide-slate-100"><tr><td class="px-4 py-3 font-bold">ë™ì§„ì„¬ìœ </td><td class="px-4 py-3">Recycled Yarn</td><td class="px-4 py-3"><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">ì™„ë£Œ</span></td><td class="px-4 py-3"><button class="text-xs text-indigo-600 hover:underline" onclick="alert('ë°ì´í„° ë³´ê¸°')">ë³´ê¸°</button></td></tr></tbody></table></div></section>
            </main>
        </div>
    </div>

    <div id="simple-mode" class="hidden h-full flex flex-col relative transition-all duration-500 z-50 bg-slate-50 absolute inset-0">
        <header class="bg-white py-4 px-6 flex justify-between items-center shadow-sm z-10"><div class="flex items-center gap-2"><div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">K</div><span class="font-bold text-slate-700 text-lg">KSIKR Easy</span></div><button onclick="toggleMode('expert')" class="text-xs font-bold text-slate-600">ì·¨ì†Œ / ë³µê·€</button></header>
        <main class="flex-1 flex flex-col items-center justify-center p-4 w-full max-w-2xl mx-auto">
            <div class="w-full bg-white rounded-2xl shadow-xl p-8 upload-zone cursor-pointer relative overflow-hidden group" onclick="triggerUpload()">
                <div id="drop-state" class="flex flex-col items-center justify-center py-10"><h3 class="text-xl font-bold text-slate-700 mb-2">í´ë¦­í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œ</h3><p class="text-sm text-slate-400">ê³ ì§€ì„œ/BOM</p></div>
                <div id="process-state" class="hidden absolute inset-0 bg-white flex flex-col items-center justify-center"><i class="fas fa-robot text-4xl text-indigo-600 animate-bounce mb-4"></i><h3 class="text-lg font-bold text-slate-800">AI ë¶„ì„ ì¤‘...</h3></div>
            </div>
            <div id="result-card" class="hidden w-full mt-6 bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden fade-in">
                <div class="p-6 space-y-4">
                    <div class="flex justify-between border-b pb-2"><p class="text-xs text-slate-400 font-bold uppercase">ì „ë ¥</p><p class="text-lg font-bold">4,520 kWh</p></div>
                    <div class="flex justify-between border-b pb-2"><p class="text-xs text-slate-400 font-bold uppercase">ìš©ìˆ˜</p><input type="number" id="simple-water" value="150" class="w-20 border-b border-indigo-200 text-lg font-bold text-right"></div>
                    <div class="flex justify-between border-b pb-2"><p class="text-xs text-slate-400 font-bold uppercase">íê¸°ë¬¼</p><input type="number" id="simple-waste" value="50" class="w-20 border-b border-indigo-200 text-lg font-bold text-right"></div>
                </div>
                <div class="px-6 pb-6"><button onclick="saveAndSwitch()" class="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold text-sm">ì €ì¥</button></div>
            </div>
        </main>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-50 hidden modal-bg flex items-center justify-center"><div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 overflow-hidden flex flex-col max-h-[90vh]"><div class="bg-indigo-900 p-4 flex justify-between items-center"><h3 class="text-white font-bold text-lg">ê¸°ì—… ì •ë³´ ì„¤ì •</h3><button onclick="closeSettingsModal()" class="text-white"><i class="fas fa-times"></i></button></div><div class="p-6 overflow-y-auto flex-1"><div class="bg-indigo-50 border border-indigo-100 p-4 rounded-lg mb-6 flex gap-2 items-end"><div class="flex-1"><label class="block text-xs font-bold text-indigo-800 mb-1">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ (Auto-Fill)</label><input type="text" id="bizNoInput" placeholder="123-45-67890" class="w-full border border-indigo-200 p-2.5 rounded text-sm"></div><button onclick="autoFillCompanyInfo()" class="bg-indigo-600 text-white px-5 py-2.5 rounded text-sm font-bold">ì¡°íšŒ</button></div><div class="grid grid-cols-2 gap-4 text-sm mb-6"><div><label class="block text-xs font-bold text-slate-500 mb-1">ê¸°ì—…ëª…</label><input type="text" id="inputCompanyName" class="w-full border p-2 rounded bg-slate-50" readonly></div><div><label class="block text-xs font-bold text-slate-500 mb-1">ëŒ€í‘œìëª…</label><input type="text" id="ceoName" class="w-full border p-2 rounded bg-slate-50" readonly></div><div class="col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">ì£¼ì†Œ</label><input type="text" id="addr" class="w-full border p-2 rounded bg-slate-50" readonly></div><div><label class="block text-xs font-bold text-slate-500 mb-1">ì£¼ìš” ì—…ì¢…</label><input type="text" id="industry" class="w-full border p-2 rounded bg-slate-50" readonly></div><div><label class="block text-xs font-bold text-slate-500 mb-1">ëŒ€ìƒ í’ˆëª©</label><input type="text" id="product" class="w-full border border-indigo-300 p-2 rounded bg-white" placeholder="ì§ì ‘ ì…ë ¥"></div></div><h4 class="text-sm font-bold text-slate-700 mb-3 border-b pb-1">ì¦ë¹™ ìë£Œ</h4><div class="grid grid-cols-2 gap-4 text-sm"><div class="border border-dashed border-slate-300 rounded p-3 flex justify-between items-center"><span>ì‚¬ì—…ìë“±ë¡ì¦</span><input type="file" class="text-[10px]"></div></div></div><div class="px-6 py-4 bg-slate-50 border-t flex justify-end gap-2"><button onclick="closeSettingsModal()" class="px-4 py-2 bg-white border rounded text-sm">ì·¨ì†Œ</button><button onclick="saveSettings()" class="px-4 py-2 bg-indigo-900 text-white rounded text-sm font-bold">ì €ì¥</button></div></div></div>
    <div id="requestModal" class="fixed inset-0 z-50 hidden modal-bg flex items-center justify-center"><div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6"><h3 class="font-bold text-lg mb-4">ê³µê¸‰ë§ ë°ì´í„° ìš”ì²­</h3><div class="mb-4"><label class="block text-xs font-bold text-slate-500">ì´ë©”ì¼</label><input type="email" class="w-full border p-2 rounded"></div><div class="flex justify-end gap-2"><button onclick="closeRequestModal()" class="px-4 py-2 bg-slate-100 rounded">ì·¨ì†Œ</button><button onclick="sendRequest()" class="px-4 py-2 bg-indigo-600 text-white rounded">ë°œì†¡</button></div></div></div>
    <div id="toast" class="fixed top-20 right-5 z-50 transform translate-x-full transition-transform duration-300 bg-white border-l-4 border-indigo-500 shadow-xl rounded p-4 flex items-center gap-3"><div class="text-indigo-500"><i class="fas fa-check-circle text-xl"></i></div><div><h4 class="font-bold text-sm">ì•Œë¦¼</h4><p class="text-xs text-slate-500" id="toast-msg">ì„±ê³µ</p></div></div>

    <script>
        // --- 0. DYNAMIC DATA & MATERIAL DB ---
        // [Data Structure Update: Recycling Rates]
        const gridDB = [ 
            {id:"KR", region:"ASIA", name:"ëŒ€í•œë¯¼êµ­ (Korea)", water_factor: 42.5, carbon_factor: 0.478, waste_factor: 0.9, acid_factor: 0.0005, paper_rec_rate: 0.85, plastic_rec_rate: 0.60}, 
            {id:"CN", region:"ASIA", name:"ì¤‘êµ­ (China)", water_factor: 25.0, carbon_factor: 0.580, waste_factor: 1.1, acid_factor: 0.0008, paper_rec_rate: 0.70, plastic_rec_rate: 0.25}, 
            {id:"VN", region:"ASIA", name:"ë² íŠ¸ë‚¨ (Vietnam)", water_factor: 2.1, carbon_factor: 0.450, waste_factor: 1.2, acid_factor: 0.0006, paper_rec_rate: 0.40, plastic_rec_rate: 0.15}, 
            {id:"IN", region:"ASIA", name:"ì¸ë„ (India)", water_factor: 60.0, carbon_factor: 0.710, waste_factor: 1.2, acid_factor: 0.0009, paper_rec_rate: 0.30, plastic_rec_rate: 0.10}, 
            {id:"FR", region:"EU", name:"í”„ë‘ìŠ¤ (France)", water_factor: 1.1, carbon_factor: 0.060, waste_factor: 0.85, acid_factor: 0.0001, paper_rec_rate: 0.90, plastic_rec_rate: 0.30}, 
            {id:"UK", region:"EU", name:"ì˜êµ­ (UK)", water_factor: 3.5, carbon_factor: 0.193, waste_factor: 0.9, acid_factor: 0.0003, paper_rec_rate: 0.80, plastic_rec_rate: 0.45}, 
            {id:"DE", region:"EU", name:"ë…ì¼ (Germany)", water_factor: 2.5, carbon_factor: 0.350, waste_factor: 0.8, acid_factor: 0.0002, paper_rec_rate: 0.95, plastic_rec_rate: 0.55}, 
            {id:"EU", region:"EU", name:"EU í‰ê·  (Europe)", water_factor: 2.5, carbon_factor: 0.230, waste_factor: 0.85, acid_factor: 0.00025, paper_rec_rate: 0.85, plastic_rec_rate: 0.40} 
        ];
        
        // Material DB
        const materialDB = {
            "Synthetic Fibers": [
                { name: "Polyester (Virgin) [EF 3.1]", ef: 5.5, ef_rec: 1.2, ef_eol: 1.5, a: 0.5, r2: 0.1, p_clim: 8, p_wat: 50, p_acid: 0.05, p_eut: 0.01, p_res: 90, p_land: 1, qp: 0.9 }, 
                { name: "Polyester (Recycled) [EF 3.1]", ef: 1.2, ef_rec: 1.2, ef_eol: 1.5, a: 0.5, r2: 0.1, p_clim: 3, p_wat: 35, p_acid: 0.02, p_eut: 0.005, p_res: 20, p_land: 1, qp: 0.9 },
                { name: "Nylon 6 (Virgin) [Ecoinvent]", ef: 7.0, ef_rec: 1.5, ef_eol: 1.7, a: 0.5, r2: 0.1, p_clim: 9, p_wat: 60, p_acid: 0.06, p_eut: 0.02, p_res: 100, p_land: 1, qp: 0.9 }
            ],
            "Natural Fibers": [
                { name: "Cotton (Conventional) [Ecoinvent]", ef: 4.5, ef_rec: 0.5, ef_eol: 0.1, a: 0.8, r2: 0.05, p_clim: 5, p_wat: 2000, p_acid: 0.03, p_eut: 0.08, p_res: 5, p_land: 9, qp: 0.8 }, 
                { name: "Cotton (Organic) [Ecoinvent]", ef: 3.8, ef_rec: 0.5, ef_eol: 0.1, a: 0.8, r2: 0.05, p_clim: 4, p_wat: 1200, p_acid: 0.01, p_eut: 0.03, p_res: 2, p_land: 8, qp: 0.8 }
            ],
            "Metals & Others": [
                { name: "Aluminum (Eyelets) [EF 3.1]", ef: 10.0, ef_rec: 1.0, ef_eol: 0.1, a: 0.2, r2: 0.9, p_clim: 9, p_wat: 20, p_acid: 0.04, p_eut: 0.005, p_res: 50, p_land: 2, qp: 1.0 }, 
                { name: "Leather (Bovine) [PEFCR]", ef: 25.0, ef_rec: 25.0, ef_eol: 0.5, a: 0.2, r2: 0.0, p_clim: 10, p_wat: 150, p_acid: 0.08, p_eut: 0.1, p_res: 10, p_land: 10, qp: 0.8 }
            ]
        };
        
        const proxyDefaults = { footwear: { elec: 2.5, water: 200, waste: 0.1, pkgP: 0.05, pkgC: 0.2 }, apparel: { elec: 5.0, water: 2500, waste: 0.15, pkgP: 0.02, pkgC: 0.1 } };

        // [Logic Update] Grid Data Loading
        function loadGridData() { 
            const s = document.getElementById('prodCountry'); s.innerHTML=""; 
            gridDB.forEach(i=>{
                const o=document.createElement('option');
                o.value=i.carbon_factor;
                o.setAttribute('data-water', i.water_factor);
                o.setAttribute('data-id', i.id);
                o.setAttribute('data-region', i.region);
                o.setAttribute('data-waste', i.waste_factor); 
                o.setAttribute('data-acid', i.acid_factor); 
                o.text=`${i.name}`;
                s.appendChild(o)
            }); 
            const c=document.createElement('option');c.value='custom';c.setAttribute('data-water', 1.0);c.setAttribute('data-waste', 1.0);c.setAttribute('data-acid', 0.0005);c.text='ê¸°íƒ€(ì…ë ¥)';s.appendChild(c); 
            
            const t = document.getElementById('targetCountry'); t.innerHTML = "";
            const targets = [
                {val: "FR", reg:"EU", txt: "ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤ (AGEC Law)"},
                {val: "UK", reg:"EU", txt: "ğŸ‡¬ğŸ‡§ ì˜êµ­ (Green Claims/PPT)"},
                {val: "DE", reg:"EU", txt: "ğŸ‡©ğŸ‡ª ë…ì¼ (LkSG)"},
                {val: "EU", reg:"EU", txt: "ğŸ‡ªğŸ‡º EU (ESPR)"},
                {val: "KR", reg:"ASIA", txt: "ğŸ‡°ğŸ‡· í•œêµ­ (K-ESG)"}
            ];
            targets.forEach(tgt => {
                const opt = document.createElement('option');
                opt.value = tgt.val;
                opt.setAttribute('data-region', tgt.reg);
                opt.text = tgt.txt;
                t.appendChild(opt);
            });
        }

        function handleGridChange() { 
            if(document.getElementById('prodCountry').value==='custom') document.getElementById('customGridWrapper').classList.remove('hidden'); 
            else document.getElementById('customGridWrapper').classList.add('hidden');
            updateRequirements();
        }

        // PEFCR Category Handler
        function handlePefcrChange() {
            const cat = document.getElementById('pefcrSelect').value;
            const washInput = document.getElementById('washInput');
            if(cat === 'footwear') {
                washInput.value = 0; 
                showToast("Footwear ê¸°ì¤€: ì„¸íƒ íšŸìˆ˜ 0íšŒ ì ìš©");
            } else {
                washInput.value = 50;
                showToast("Apparel ê¸°ì¤€: ì„¸íƒ íšŸìˆ˜ 50íšŒ ì ìš©");
            }
        }
        
        // Distribution Channel Change Handler (Return Rate Display)
        document.getElementById('distChannel').addEventListener('change', function() {
            const ch = this.value;
            const disp = document.getElementById('return-rate-display');
            if(ch === 'online') disp.innerText = "ë°˜í’ˆë¥  ìë™ ì ìš©: 30% (Reverse Logistics í¬í•¨)";
            else if(ch === 'omni') disp.innerText = "ë°˜í’ˆë¥  ìë™ ì ìš©: 15% (Reverse Logistics í¬í•¨)";
            else disp.innerText = "ë°˜í’ˆë¥  ìë™ ì ìš©: 1% (ë§¤ì¥ ë°˜í’ˆ)";
        });

        // --- 1. View & Navigation ---
        function toggleMode(target) { const s=document.getElementById('simple-mode'); const e=document.getElementById('expert-mode'); if(target==='simple'){s.classList.remove('hidden');e.classList.add('hidden');}else{s.classList.add('hidden');e.classList.remove('hidden');initChart();} }
        function switchTab(id) { document.querySelectorAll('main section').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active')); document.getElementById('nav-'+id).classList.add('nav-active'); }
        function showToast(msg) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=msg; t.classList.remove('translate-x-full'); setTimeout(()=>t.classList.add('translate-x-full'),3000); }

        // --- 2. Chart Logic ---
        let chart=null;
        const pefLabels = ['Climate','Ozone','Cancer','Non-Cancer','PM','Radiation','Ozone(Photo)','Acidification','Eutrophication','Eut(F)','Eut(M)','Eco(F)','Land Use','Water Scarcity','Resource(Min)','Resource(Fos)'];
        
        function initChart() { if(chart) return; const ctx = document.getElementById('emissionsChart').getContext('2d'); chart = new Chart(ctx, { type: 'bar', data: { labels: ['1ì›”','2ì›”'], datasets: [{ label: 'ì´ˆê¸°í™” ì¤‘...', data: [0,0] }] }, options: { responsive: true, maintainAspectRatio: false } }); }
        
        function updateChartType(type) {
            const btnM = document.getElementById('btn-monthly'); const btnR = document.getElementById('btn-accumulated');
            if(type === 'monthly') { 
                btnM.className = 'toggle-btn active px-3 py-1.5 rounded-md bg-white text-indigo-600 shadow-sm'; btnR.className = 'toggle-btn px-3 py-1.5 rounded-md text-slate-500'; 
                chart.destroy(); 
                chart = new Chart(document.getElementById('emissionsChart'), { type: 'bar', data: { labels: ['1ì›”','2ì›”','3ì›”'], datasets: [{ label: 'ì›”ë³„ ë°°ì¶œëŸ‰', data: [15,14,13], backgroundColor: '#4f46e5' }] }, options: { responsive: true, maintainAspectRatio: false } }); 
            } else { 
                btnR.className = 'toggle-btn active px-3 py-1.5 rounded-md bg-white text-indigo-600 shadow-sm'; btnM.className = 'toggle-btn px-3 py-1.5 rounded-md text-slate-500'; 
                const dynamicData = window.currentRadarData || Array(16).fill(50);
                chart.destroy(); 
                chart = new Chart(document.getElementById('emissionsChart'), { type: 'radar', data: { labels: pefLabels, datasets: [{ label: 'ìš°ë¦¬ ì œí’ˆ (Real-time)', data: dynamicData, backgroundColor: 'rgba(79, 70, 229, 0.2)', borderColor: '#4f46e5', pointBackgroundColor: '#4f46e5' }, { label: 'EU í‰ê· ', data: Array(16).fill(100), borderColor: '#94a3b8', borderDash: [5, 5], fill: false }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMin: 0, suggestedMax: 120, ticks: { display: false } } } } }); 
            }
        }

        // --- 3. Calculation Logic (v72.0 Final Gold) ---
        function addMaterialRow() {
            const tbody = document.getElementById('material-review-body');
            const tr = document.createElement('tr');
            tr.className = "border-b border-slate-100 material-row";
            let opts = ''; 
            for(const [c,m] of Object.entries(materialDB)) {
                opts += `<optgroup label="${c}">`;
                m.forEach(mat => {
                    opts += `<option value="${mat.ef}" data-efrec="${mat.ef_rec}" data-efeol="${mat.ef_eol}" data-a="${mat.a}" data-r2="${mat.r2}" data-pclim="${mat.p_clim}" data-pwat="${mat.p_wat}" data-pacid="${mat.p_acid}" data-peut="${mat.p_eut}" data-pres="${mat.p_res}" data-pland="${mat.p_land}" data-qp="${mat.qp}">${mat.name}</option>`;
                });
                opts += `</optgroup>`;
            }

            tr.innerHTML = `
                <td class="px-4 py-3 font-medium text-slate-400 italic">Manual Entry</td>
                <td class="px-4 py-3"><select class="mat-select w-full border p-1 rounded text-sm bg-white">${opts}</select></td>
                <td class="px-4 py-3 text-right"><input type="number" class="mat-weight w-16 border rounded text-right p-1 text-sm" value="0"></td>
                <td class="px-4 py-3 text-center"><input type="number" class="mat-scrap w-12 border rounded text-center p-1 text-sm bg-red-50 text-red-700 font-bold" value="0"></td>
                <td class="px-4 py-3 text-center"><input type="number" class="mat-r1 w-12 border rounded text-center p-1 text-sm" value="0"></td>
                <td class="px-4 py-3 text-center"><button onclick="this.closest('tr').remove()" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(tr);
        }

        function handleBomUpload() {
            document.getElementById('lca-workspace').classList.remove('hidden');
            const tbody = document.getElementById('material-review-body');
            tbody.innerHTML = '';
            
            const aiData = [
                { name: "UPPER_FABRIC_POLY_01", map: "Polyester (Virgin) [EF 3.1]", w: 0.45, scrap: 15, r1: 0, conf: "High" },
                { name: "OUTSOLE_RUB_BLK", map: "Polyester (Recycled) [EF 3.1]", w: 0.30, scrap: 5, r1: 0, conf: "Medium" }, 
                { name: "INSOLE_EVA_V2", map: "Cotton (Conventional) [Ecoinvent]", w: 0.15, scrap: 10, r1: 0, conf: "Low" }
            ];

            aiData.forEach(d => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-100 material-row";
                let opts = ''; 
                for(const [c,m] of Object.entries(materialDB)) {
                    opts += `<optgroup label="${c}">`;
                    m.forEach(mat => {
                        const sel = (mat.name === d.map) ? 'selected' : '';
                        opts += `<option value="${mat.ef}" data-efrec="${mat.ef_rec}" data-efeol="${mat.ef_eol}" data-a="${mat.a}" data-r2="${mat.r2}" data-pclim="${mat.p_clim}" data-pwat="${mat.p_wat}" data-pacid="${mat.p_acid}" data-peut="${mat.p_eut}" data-pres="${mat.p_res}" data-pland="${mat.p_land}" data-qp="${mat.qp}" ${sel}>${mat.name}</option>`;
                    });
                    opts += `</optgroup>`;
                }
                
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-slate-700">${d.name}</td>
                    <td class="px-4 py-3">
                        <select class="mat-select w-full border p-1 rounded text-sm bg-indigo-50 text-indigo-700 font-bold" data-conf="${d.conf}">${opts}</select>
                        <span class="text-[10px] text-slate-400">ì‹ ë¢°ë„: ${d.conf}</span>
                    </td>
                    <td class="px-4 py-3 text-right"><input type="number" class="mat-weight w-16 border rounded text-right p-1 text-sm" value="${d.w}"></td>
                    <td class="px-4 py-3 text-center"><input type="number" class="mat-scrap w-12 border rounded text-center p-1 text-sm bg-red-50 text-red-700 font-bold" value="${d.scrap}"></td>
                    <td class="px-4 py-3 text-center"><input type="number" class="mat-r1 w-12 border rounded text-center p-1 text-sm" value="${d.r1}"></td>
                    <td class="px-4 py-3 text-center"><i class="fas fa-check-circle text-green-500"></i></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('elecInput').value = 2.1;
            document.getElementById('gasInput').value = 0.5; 
            document.getElementById('chemInput').value = ""; 
            document.getElementById('waterInput').value = 150;
            document.getElementById('wasteInput').value = 0.05; 
            document.getElementById('pkgPaperInput').value = 0.2;
            
            showToast("BOM ì—…ë¡œë“œ ì™„ë£Œ. ê²€ìˆ˜ í…Œì´ë¸”ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function calculatePEF() {
            let totalMatImpact = 0;
            let totalProductWeight = 0;
            let totalScrapWaste = 0;
            let totalGrossWeight = 0; 
            let radarScores = { clim: 0, wat: 0, res: 0, land: 0, acid: 0, eut: 0 };
            let totalDqrScore = 0;

            const rows = document.querySelectorAll('#material-review-body tr');
            if(rows.length === 0) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

            let totalR1=0; let totalR2=0;
            const currentCat = document.getElementById('pefcrSelect').value;
            const isFootwear = (currentCat === 'footwear');
            // [CRITICAL FIX] Removed static Global AWARE factor to enforce regional specificity
            
            const prodSel = document.getElementById('prodCountry');
            const prodWasteFactor = (prodSel.value !== 'custom') 
                ? parseFloat(prodSel.options[prodSel.selectedIndex].getAttribute('data-waste')) || 1.0 
                : 1.0;
            const prodAcidFactor = (prodSel.value !== 'custom')
                ? parseFloat(prodSel.options[prodSel.selectedIndex].getAttribute('data-acid')) || 0.0005
                : 0.0005;
            const prodRegion = (prodSel.value !== 'custom') 
                ? prodSel.options[prodSel.selectedIndex].getAttribute('data-region') 
                : 'ASIA';
            const prodWaterFactor = (prodSel.value !== 'custom')
                ? parseFloat(prodSel.options[prodSel.selectedIndex].getAttribute('data-water'))
                : 42.5;

            const targetCountryID = document.getElementById('targetCountry').value;
            const targetData = gridDB.find(g => g.id === targetCountryID) || { carbon_factor: 0.475, water_factor: 42.5, waste_factor: 1.0, region: 'EU', paper_rec_rate: 0.5, plastic_rec_rate: 0.3 };
            const targetWasteFactor = targetData.waste_factor || 1.0;

            const sourcingType = document.getElementById('sourcingSelect').value;

            // [CRITICAL FIX] Dynamic Material Water Stress Factor based on Sourcing
            let matWaterFactor = 42.5; // Default Global
            if(sourcingType === 'local') {
                matWaterFactor = prodWaterFactor; // Use Factory Country's stress
            } else if (sourcingType === 'regional') {
                matWaterFactor = (prodWaterFactor + 42.5) / 2; // Simplified average
            }

            rows.forEach(row => {
                const sel = row.querySelector('.mat-select');
                const opt = sel.options[sel.selectedIndex];
                const ef_v = parseFloat(sel.value); 
                const ef_rec = parseFloat(opt.getAttribute('data-efrec')); 
                const ef_eol = parseFloat(opt.getAttribute('data-efeol'));
                const a = parseFloat(opt.getAttribute('data-a')); 
                const qp = parseFloat(opt.getAttribute('data-qp')) || 1.0;
                
                let r2 = parseFloat(opt.getAttribute('data-r2'));
                if(isFootwear) { r2 = 0.0; } 

                const p_clim = parseFloat(opt.getAttribute('data-pclim'));
                const p_wat = parseFloat(opt.getAttribute('data-pwat'));
                const p_acid = parseFloat(opt.getAttribute('data-pacid')) || 0.01;
                const p_eut = parseFloat(opt.getAttribute('data-peut')) || 0.001;
                const p_res = parseFloat(opt.getAttribute('data-pres')) || 10;
                const p_land = parseFloat(opt.getAttribute('data-pland')) || 1;
                
                const netW = parseFloat(row.querySelector('.mat-weight').value) || 0;
                const scrapRate = parseFloat(row.querySelector('.mat-scrap').value || 0) / 100;
                const r1 = parseFloat(row.querySelector('.mat-r1').value || 0) / 100;
                
                const confStr = sel.getAttribute('data-conf') || "Medium";
                let confScore = 3; 
                if (prodRegion === 'ASIA') confScore += 1; 

                if(confStr === "High") confScore = Math.max(1, confScore - 1); 
                else if(confStr === "Low") confScore = Math.min(5, confScore + 1);
                
                totalDqrScore += (confScore * netW);

                const grossW = netW / (1 - scrapRate);
                const scrapW = grossW - netW;
                
                totalScrapWaste += scrapW;
                totalProductWeight += netW; 
                totalGrossWeight += grossW;
                totalR1 += (netW * r1); totalR2 += (netW * r2);

                const production = (1 - r1) * ef_v + r1 * (a * ef_v + (1 - a) * ef_rec);
                const disposal = (1 - r2) * ef_eol * targetWasteFactor; 
                const eolCredit = r2 * (ef_rec - ef_v * qp) * (1-a);
                const scrapImpact = scrapW * (ef_eol * 1.2 * prodWasteFactor); 

                totalMatImpact += (grossW * production) + (netW * (disposal + eolCredit)) + scrapImpact;
                
                radarScores.clim += p_clim * grossW;
                radarScores.wat += p_wat * grossW; 
                radarScores.acid += p_acid * grossW;
                radarScores.eut += p_eut * grossW;
                radarScores.res += p_res * grossW;
                radarScores.land += p_land * grossW;
            });

            const finalDQR = totalProductWeight > 0 ? (totalDqrScore / totalProductWeight).toFixed(1) : "3.0";
            document.getElementById('dqr-score').innerHTML = `${finalDQR} <span class="text-sm font-normal text-slate-500">/ 5.0</span>`;

            // 1. Process Energy & RE100 Logic
            const wasteProcess = parseFloat(document.getElementById('wasteInput').value)||0;
            const wasteImpact = wasteProcess * 0.5 * prodWasteFactor;
            const totalWasteDisplay = wasteProcess + totalScrapWaste;

            let gridSelect = document.getElementById('prodCountry');
            let prodCarbonFactor = gridSelect.value==='custom' ? parseFloat(document.getElementById('customGridFactor').value) : parseFloat(gridSelect.value);
            
            const elec = parseFloat(document.getElementById('elecInput').value)||0;
            const re100 = parseFloat(document.getElementById('renewableInput').value) || 0;
            const reFactor = re100 / 100;
            const renewableEF = 0.01; 
            const finalElecFactor = (prodCarbonFactor * (1 - reFactor)) + (renewableEF * reFactor);
            
            const elecImpact = elec * finalElecFactor * 1.1; 
            radarScores.acid += (elec * (1-reFactor) * prodAcidFactor); 
            
            let gasInputVal = document.getElementById('gasInput').value;
            let gas = parseFloat(gasInputVal);
            if(gasInputVal === "" || isNaN(gas)) { 
                const thermalRatio = isFootwear ? 0.5 : 1.5; 
                gas = elec * thermalRatio; 
            }
            const fuelFactor = parseFloat(document.getElementById('fuelSource').value) || 0.056;
            const gasImpact = gas * fuelFactor; 
            let boilerAcidFactor = (fuelFactor > 0.09) ? 0.0008 : 0.0001; 
            radarScores.acid += (gas * boilerAcidFactor);
            
            let chemInputVal = document.getElementById('chemInput').value;
            let chem = parseFloat(chemInputVal);
            if(chemInputVal === "" || isNaN(chem)) {
                const chemRatio = isFootwear ? 0.05 : 0.2;
                chem = totalProductWeight * chemRatio;
            }
            const chemImpact = chem * 3.0;
            radarScores.eut += chem * 0.05; 

            const waterVol = parseFloat(document.getElementById('waterInput').value)||0;
            const waterCarbonFactor = 0.3 * finalElecFactor; 
            const mfgWaterCarbon = (waterVol / 1000) * waterCarbonFactor;
            const wastewaterFactor = 0.0005; 
            radarScores.eut += waterVol * wastewaterFactor;

            const impactEnergy = elecImpact + gasImpact + chemImpact + mfgWaterCarbon;

            // 2. Packaging Impact
            const pkgP = parseFloat(document.getElementById('pkgPlasticInput').value)||0;
            const pkgC = parseFloat(document.getElementById('pkgPaperInput').value)||0;
            const pkgProduction = (pkgP * 2.5) + (pkgC * 0.9);
            
            const paperRecRate = targetData.paper_rec_rate || 0.5;
            const plasticRecRate = targetData.plastic_rec_rate || 0.3;
            
            const pkgPaperEoL = pkgC * ((paperRecRate * 0.1) + ((1 - paperRecRate) * 0.5 * targetWasteFactor));
            const pkgPlasticEoL = pkgP * ((plasticRecRate * 0.5) + ((1 - plasticRecRate) * 1.5 * targetWasteFactor));
            
            const pkgEoL = pkgPaperEoL + pkgPlasticEoL; 
            const pkgImpact = pkgProduction + pkgEoL;
            radarScores.res += pkgP * 50; 
            
            // 3. Logistics
            let inboundDist = 15000; 
            let inboundImpact = 0;
            
            const rawMatWeight = totalGrossWeight;
            const auxWeight = pkgP + pkgC + chem;
            const seaFactor = 0.00001;
            const truckFactor = 0.00006;

            if(sourcingType === 'local') { 
                inboundImpact = (rawMatWeight + auxWeight) * 500 * truckFactor;
            } else if(sourcingType === 'regional') { 
                inboundImpact = (rawMatWeight + auxWeight) * 2500 * truckFactor;
            } else { 
                const seaLeg = (rawMatWeight + auxWeight) * 15000 * seaFactor;
                const drayageLeg = (rawMatWeight + auxWeight) * 300 * truckFactor; 
                inboundImpact = seaLeg + drayageLeg;
            }
            radarScores.acid += inboundImpact * 0.1;

            const totalLogiWeight = totalProductWeight + pkgP + pkgC;
            const inlandDist = parseFloat(document.getElementById('inlandDist').value)||0; 
            const targetDist = parseFloat(document.getElementById('transportInput').value)||0;
            const mode = document.getElementById('transMode').value;
            
            let mainModeFactor = (mode === 'air') ? 0.0005 : ((mode === 'road') ? 0.00006 : 0.00001);
            let volFactor = 1.0; 
            
            const densityFactor = isFootwear ? 3.5 : 5.0;

            const distChannel = document.getElementById('distChannel').value;
            let retailEnergyIntensity = 0.3; 
            let lastMileFactor = 0.1; 
            let secondaryPkg = 0; 
            let returnRate = 0.01; 

            if(distChannel === 'online') {
                retailEnergyIntensity = 0.1; 
                lastMileFactor = 0.5; 
                secondaryPkg = totalProductWeight * 0.1 * 0.9; 
                returnRate = 0.30; 
            } else if (distChannel === 'omni') {
                retailEnergyIntensity = 0.2; 
                lastMileFactor = 0.3;
                secondaryPkg = totalProductWeight * 0.05 * 0.9;
                returnRate = 0.15; 
            }

            const outboundTransport = (totalLogiWeight * inlandDist * truckFactor) + (totalLogiWeight * targetDist * mainModeFactor * volFactor * densityFactor);
            
            const retailEnergyImpact = totalProductWeight * retailEnergyIntensity * targetData.carbon_factor; 
            const lastMileImpact = totalProductWeight * lastMileFactor;
            const returnImpact = totalProductWeight * returnRate * (lastMileFactor * 1.5);

            const impactLogistics = inboundImpact + outboundTransport + retailEnergyImpact + lastMileImpact + secondaryPkg + returnImpact;

            // 4. Use Phase
            const washes = parseFloat(document.getElementById('washInput').value)||0;
            const tempVal = parseInt(document.getElementById('washTemp').value) || 40;
            let energyPerKg = 0.16; 
            if(tempVal <= 20) energyPerKg = 0.06;
            else if(tempVal <= 30) energyPerKg = 0.1;
            else if(tempVal <= 40) energyPerKg = 0.16;
            else if(tempVal <= 60) energyPerKg = 0.3;
            else energyPerKg = 0.5;

            if(isFootwear && washes > 0) energyPerKg = 0.1;

            const useElecImpact = (washes * energyPerKg * totalProductWeight * targetData.carbon_factor * 1.1); 
            
            let detergentImpact = 0;
            if (!isFootwear && washes > 0) {
                const detergentWeight = totalProductWeight * 0.015 * washes; 
                detergentImpact = detergentWeight * 2.5;
                radarScores.eut += detergentWeight * 0.2; 
            }
            
            let ironingImpact = 0;
            if (!isFootwear && washes > 0) {
                const ironingFrequency = 0.5; 
                ironingImpact = (washes * ironingFrequency) * 0.2 * targetData.carbon_factor; 
            }

            let dryingImpact = 0;
            if (!isFootwear && washes > 0) {
                dryingImpact = (washes * 0.2) * totalProductWeight * 0.8 * targetData.carbon_factor;
            }

            const impactUseWaterL = washes * 12 * totalProductWeight; 
            const useWaterCarbonFactor = 0.3 * targetData.carbon_factor;
            const useWaterCarbon = (impactUseWaterL / 1000) * useWaterCarbonFactor;
            radarScores.eut += (impactUseWaterL * 0.0002); 

            const impactUseTotal = useElecImpact + detergentImpact + ironingImpact + dryingImpact + useWaterCarbon;

            // 5. Deadstock Handling
            const deadstockRate = 0.05; 
            const cradleToGateImpact = totalMatImpact + impactEnergy + pkgProduction + inboundImpact;
            const deadstockProductionBurden = cradleToGateImpact * deadstockRate;
            const deadstockDisposalImpact = totalProductWeight * deadstockRate * (1.5 * targetWasteFactor); 
            const totalDeadstockImpact = deadstockProductionBurden + deadstockDisposalImpact;
            
            const machineryImpact = totalProductWeight * 0.05;

            // Total Climate Impact
            const impactClimate = totalMatImpact + pkgImpact + impactEnergy + impactLogistics + impactUseTotal + wasteImpact + totalDeadstockImpact + machineryImpact;

            // Water Scarcity (Corrected with matWaterFactor)
            const waterScarcityMat = radarScores.wat * matWaterFactor; 
            const waterScarcityMfg = waterVol * prodWaterFactor;
            const waterScarcityUse = impactUseWaterL * targetData.water_factor;
            const totalWaterScarcity = (waterScarcityMat + waterScarcityMfg + waterScarcityUse) / 1000;

            const n_clim = Math.min(100, (impactClimate / 20) * 100); 
            const n_acid = Math.min(100, (radarScores.acid * 500)); 
            const n_eut = Math.min(100, (radarScores.eut * 1000));
            const n_res = Math.min(100, (radarScores.res / 10));
            const n_wat = Math.min(100, (totalWaterScarcity / 5) * 100);

            window.currentRadarData = [
                n_clim, 60, 50, 55, 70, 40, 60, 
                n_acid, n_eut, n_eut, n_eut, 
                75, 
                (radarScores.land * 5), 
                n_wat, 
                40, n_res
            ];

            // Display Results
            document.getElementById('total-carbon-display').innerText = impactClimate.toFixed(2);
            document.getElementById('dashboard-water').innerText = totalWaterScarcity.toFixed(2); 
            const totalWasteWithDeadstock = totalWasteDisplay + (totalProductWeight * deadstockRate);
            document.getElementById('dashboard-waste').innerText = (totalWasteWithDeadstock/1000).toFixed(3) + " ton";
            
            const mciScore = totalProductWeight > 0 ? ((totalR1/totalProductWeight) + (totalR2/totalProductWeight))/2 : 0;
            document.getElementById('mci-score').innerText = `MCI ${mciScore.toFixed(2)}`;
            document.getElementById('mci-grade').innerText = mciScore > 0.7 ? "Grade A" : (mciScore > 0.4 ? "Grade B" : "Grade C");

            document.getElementById('pef-results').style.opacity = '1';
            document.getElementById('pef-results').innerHTML = `<div class="bg-white p-4 rounded border border-slate-200 shadow-sm text-center"><h3 class="text-2xl font-bold text-indigo-700 mb-1">${impactClimate.toFixed(2)} <span class="text-sm text-slate-500">kgCO2e</span></h3><p class="text-xs text-slate-400">ìµœì¢… ìŠ¹ì¸ ì™„ë£Œ (v72.0 Final Gold)</p><div class="mt-4 grid grid-cols-3 gap-2 text-xs"><div class="bg-slate-50 p-2 rounded"><strong>${impactUseTotal.toFixed(2)}</strong><br>Use Phase</div><div class="bg-slate-50 p-2 rounded"><strong>${totalDeadstockImpact.toFixed(2)}</strong><br>Deadstock</div><div class="bg-slate-50 p-2 rounded"><strong>${impactLogistics.toFixed(2)}</strong><br>Logistics (Vol. W)</div></div></div>`;

            showToast("ìµœì¢… ì‚°ì¶œ ì™„ë£Œ (ISO/PEF Compliant)");
        }

        // --- Common Utils ---
        function fillMissingData() {
            const defaults = proxyDefaults['footwear']; let count=0;
            const fill=(id,val)=>{const el=document.getElementById(id);if(!el.value||el.value==0){el.value=val;el.classList.add('proxy-data');count++;}};
            fill('elecInput', defaults.elec); fill('waterInput', defaults.water); fill('wasteInput', defaults.waste);
            fill('pkgPlasticInput', defaults.pkgP); fill('pkgPaperInput', defaults.pkgC);
            if(count>0) { showToast(`${count}ê°œ í•­ëª© ìë™ ì±„ìš°ê¸° ì™„ë£Œ`); }
        }

        function updateRequirements() { 
             const t = document.getElementById('targetCountry');
             const c = t.value; 
             const modeSel = document.getElementById('transMode');
             const pSel = document.getElementById('prodCountry');
             let dist = 10000; 
             
             if (pSel.value !== 'custom') {
                 const pOpt = pSel.options[pSel.selectedIndex];
                 const pId = pOpt.getAttribute('data-id');
                 const pReg = pOpt.getAttribute('data-region');
                 const tOpt = t.options[t.selectedIndex];
                 const tReg = tOpt.getAttribute('data-region');

                 if (pId === c) {
                     dist = 400; modeSel.value = 'road'; 
                 } else if (pReg === 'ASIA' && tReg === 'ASIA') {
                     dist = 3000; modeSel.value = 'sea'; 
                 } else if (pReg === 'EU' && tReg === 'EU') {
                     dist = 1000; modeSel.value = 'road'; 
                 } else {
                     dist = 19000; if(modeSel.value === 'road') modeSel.value = 'sea'; 
                 }
             }

             const content = document.getElementById('report-content');
             const coName = document.getElementById('header-company-name').innerText;
             const date = new Date().toISOString().split('T')[0];
             
             if(c === 'DE') content.innerHTML = `<div class="report-de"><h2 class="text-xl font-bold mb-4">Bericht (LkSG)</h2><p class="text-xs">Unternehmen: ${coName}</p><p class="text-xs">Datum: ${date}</p><table class="w-full border mt-4 text-xs"><tr><th>Bereich</th><th>Status</th></tr><tr><td>Umwelt</td><td>Konform</td></tr></table></div>`;
             else if (c === 'UK') content.innerHTML = `<div class="report-uk"><h2 class="text-xl font-bold mb-4">UK PPT Return</h2><p class="text-xs font-mono">Entity: ${coName}</p><table class="w-full border mt-4 text-xs"><tr><th>Category</th><th>Weight</th></tr><tr><td>Plastic</td><td>${document.getElementById('pkgPlasticInput').value}kg</td></tr></table></div>`;
             else if (c === 'KR') content.innerHTML = `<div class="report-kr"><h2 class="text-xl font-bold text-center mb-6 text-green-700">í™˜ê²½ì„±ì í‘œì§€ ì¸ì¦ ê²°ê³¼ì„œ</h2><div class="grid grid-cols-2 gap-4 text-xs border p-4"><div><strong>ìƒí˜¸:</strong> ${coName}</div><div><strong>ì¸ì¦ì¼ì:</strong> ${date}</div></div></div>`;
             else content.innerHTML = `<div class="report-fr"><h2 class="text-lg font-bold text-green-700">Fiche Produit (AGEC)</h2><p class="text-sm">ConformitÃ©: OUI</p></div>`;
             
             const distInput = document.getElementById('transportInput');
             distInput.value = dist;
             distInput.removeAttribute('readonly'); 
        }

        function printReport() {
            const printContent = document.getElementById('report-content').innerHTML;
            const originalContents = document.body.innerHTML;
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContents;
            location.reload(); 
        }

        function generateReport() { showToast("ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"); }
        function autoFillCompanyInfo() { setTimeout(() => { 
            document.getElementById('inputCompanyName').value = "(ì£¼)ëŒ€ì„±ì‹ ë°œ"; 
            document.getElementById('ceoName').value = "í™ê¸¸ë™";
            document.getElementById('bizNoInput').value = "110-11-12345"; 
            document.getElementById('addr').value = "ë¶€ì‚°ê´‘ì—­ì‹œ ì‚¬ìƒêµ¬ ì‹ ë°œì‚°ì—…ë‹¨ì§€ë¡œ 123";
            document.getElementById('industry').value = "ì‹ ë°œ ì œì¡°ì—… (C1521)";
            showToast("ìë™ ì…ë ¥ ì™„ë£Œ"); 
        }, 1000); }
        function downloadTemplate() { showToast("í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ"); }
        function downloadReport(b){ b.innerHTML='...'; setTimeout(()=>{b.innerHTML='ì™„ë£Œ';},1000);}
        function resetSimple(){/*...*/}; function saveAndSwitch(){toggleMode('expert');}
        function openSettingsModal() { document.getElementById('settingsModal').classList.remove('hidden'); }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.add('hidden'); }
        function saveSettings() { document.getElementById('header-company-name').innerText = document.getElementById('inputCompanyName').value || "(ì£¼)ëŒ€ì„±ì‹ ë°œ"; closeSettingsModal(); }
        function openRequestModal() { document.getElementById('requestModal').classList.remove('hidden'); }
        function closeRequestModal() { document.getElementById('requestModal').classList.add('hidden'); }
        function sendRequest() { closeRequestModal(); showToast("ë°œì†¡ ì™„ë£Œ"); }
        function simulateAiBOM() { /* Replaced by handleBomUpload */ }

        // [Event Listener Add]
        document.getElementById('pefcrSelect').addEventListener('change', handlePefcrChange);

        initChart(); loadGridData(); updateRequirements();
    </script>
</body>
</html>
